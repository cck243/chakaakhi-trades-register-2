<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sales & Purchase ‚Äî Fixed</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --accent: #2b7a78; --muted: #6b7280; --border: #e5e7eb; --bg: #f9fafb;
      --card-bg: #ffffff; --text: #111827; --shadow: rgba(15, 23, 42, 0.06);
    }
    [data-theme="dark"] {
      --accent: #14a8a5; --muted: #9ca3af; --border: #374151; --bg: #111827;
      --card-bg: #1f2937; --text: #f3f4f6; --shadow: rgba(0, 0, 0, 0.2);
    }
    body { font-family: 'Inter', system-ui, sans-serif; margin: 0; background: var(--bg); color: var(--text); transition: background 0.3s ease; }
    header { background: var(--accent); color: white; padding: 14px 18px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    header h1 { font-size: 18px; font-weight: 600; margin: 0; }
    .wrap { display: flex; gap: 16px; padding: 16px; align-items: flex-start; }
    nav { width: 260px; background: var(--card-bg); padding: 12px; border-radius: 12px; box-shadow: 0 6px 18px var(--shadow); }
    nav button { display: flex; gap: 10px; align-items: center; width: 100%; padding: 10px 12px; border-radius: 8px; border: none; background: transparent; cursor: pointer; color: var(--text); font-size: 14px; text-align: left; transition: all 0.2s; }
    nav button:hover { background: rgba(43, 122, 120, 0.08); }
    nav button.active { background: linear-gradient(90deg, rgba(43,122,120,.1), rgba(43,122,120,.05)); font-weight: 600; color: var(--accent); }
    main { flex: 1; background: var(--card-bg); padding: 16px; border-radius: 12px; box-shadow: 0 6px 18px var(--shadow); }
    h2 { margin: 0 0 16px 0; font-size: 20px; font-weight: 600; }
    .row { display: flex; gap: 12px; margin-bottom: 8px; flex-wrap: wrap; }
    .col { flex: 1; min-width: 150px; }
    label { font-size: 13px; font-weight: 500; margin-bottom: 4px; display: block; }
    input, select, textarea, button { font-family: inherit; font-size: 14px; }
    input, select, textarea { padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); width: 100%; box-sizing: border-box; }
    input:focus, select:focus, textarea:focus { outline: 2px solid var(--accent); border-color: var(--accent); }
    button.btn { padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: 500; transition: opacity 0.2s; }
    button.btn:hover { opacity: 0.85; }
    button.primary { background: var(--accent); color: white; } button.ghost { background: transparent; border: 1px solid var(--border); color: var(--text); } button.danger { background: #ef4444; color: white; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { padding: 10px 12px; border-bottom: 1px solid var(--border); text-align: left; font-size: 14px; }
    th { background: rgba(43, 122, 120, 0.05); font-weight: 600; }
    td .btn { padding: 4px 8px; font-size: 12px; }
    .right { text-align: right; } .center { text-align: center; } .small { font-size: 12px; color: var(--muted); } .bold { font-weight: 600; }
    .card { background: var(--card-bg); padding: 16px; border-radius: 10px; box-shadow: 0 2px 6px var(--shadow); margin-bottom: 16px; }
    .toast { position: fixed; top: 20px; right: 20px; padding: 12px 16px; border-radius: 8px; background: #333; color: white; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; transform: translateY(-10px); transition: all 0.3s ease; }
    .toast.show { opacity: 1; transform: translateY(0); }
    footer { padding: 16px; text-align: center; color: var(--muted); font-size: 13px; }
    .theme-toggle { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 10px; border-radius: 8px; cursor: pointer; }
    @media (max-width: 880px) { .wrap { flex-direction: column; } nav { width: 100%; } }
  </style>
</head>
<body>
  <header>
    <h1>Sales & Purchase Management</h1>
    <button class="theme-toggle" onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>
  </header>

  <div class="wrap">
    <nav id="nav">
      <button data-tab="dashboard" class="active">Dashboard</button>
      <button data-tab="products">Products & Stock</button>
      <button data-tab="customers">Customers</button>
      <button data-tab="suppliers">Suppliers</button>
      <button data-tab="sales">Sales Invoices</button>
      <button data-tab="purchases">Purchase Bills</button>
      <button data-tab="payments">Payments & Receipts</button>
      <button data-tab="reports">Reports & Export</button>
    </nav>
    <main id="main"></main>
  </div>

  <footer>Fully offline. Data saved in browser. Export/Import JSON in Reports.</footer>
  <div id="toast" class="toast"></div>

  <script>
    // ========== STATE & UTILS ==========
    const main = document.getElementById('main');
    const nav = document.getElementById('nav');
    let currentEditingId = null; // Used for editing items across tabs

    const uid = (p = 'id') => p + Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
    const fmt = n => Number(n || 0).toLocaleString('en-IN', { maximumFractionDigits: 2 });
    const today = () => new Date().toISOString().slice(0, 10);
    const LS_KEYS = ['products', 'customers', 'suppliers', 'sales', 'purchases', 'payments'];

    function load(key) { try { return JSON.parse(localStorage.getItem(key) || '[]'); } catch { return []; } }
    function save(key, arr) { localStorage.setItem(key, JSON.stringify(arr || [])); }

    // ========== TOAST ==========
    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.className = 'toast show';
      setTimeout(() => { toast.className = 'toast'; }, 3000);
    }

    // ========== THEME ==========
    function toggleTheme() {
      const root = document.documentElement;
      const isDark = root.getAttribute('data-theme') === 'dark';
      root.setAttribute('data-theme', isDark ? 'light' : 'dark');
      localStorage.setItem('theme', isDark ? 'light' : 'dark');
    }
    if (localStorage.getItem('theme') === 'dark') document.documentElement.setAttribute('data-theme', 'dark');

    // ========== INITIAL DATA ==========
    function initIfEmpty() {
      if (!load('products').length) save('products', [
        { id: uid('p'), sku: 'P-001', name: 'Widget A', category: 'General', price: 100, cost: 70, stock: 50, unit: 'pcs', minStock: 5 },
        { id: uid('p'), sku: 'P-002', name: 'Widget B', category: 'General', price: 200, cost: 140, stock: 30, unit: 'pcs', minStock: 5 }
      ]);
      if (!load('customers').length) save('customers', [{ id: uid('c'), name: 'Walk-in Customer', phone: '', email: '', address: '' }]);
      if (!load('suppliers').length) save('suppliers', [{ id: uid('s'), name: 'General Supplier', phone: '', email: '', address: '' }]);
      if (!load('sales').length) save('sales', []);
      if (!load('purchases').length) save('purchases', []);
      if (!load('payments').length) save('payments', []);
    }
    initIfEmpty();

    // ========== ROUTING & RENDERING ==========
    nav.addEventListener('click', e => {
      const btn = e.target.closest('button[data-tab]');
      if (!btn) return;
      document.querySelectorAll('#nav button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentEditingId = null; // Reset editing state on tab change
      render(btn.dataset.tab);
    });

    function render(tab = 'dashboard') {
      const data = LS_KEYS.reduce((acc, k) => ({ ...acc, [k]: load(k) }), {});
      const renderMap = {
        dashboard: renderDashboard,
        products: renderProducts,
        customers: () => renderEntity('customers', 'Customer', ['name', 'phone', 'email', 'address']),
        suppliers: () => renderEntity('suppliers', 'Supplier', ['name', 'phone', 'email', 'address']),
        sales: () => renderTransactions('sales', 'Sales Invoice', 'customers'),
        purchases: () => renderTransactions('purchases', 'Purchase Bill', 'suppliers'),
        payments: renderPayments,
        reports: renderReports,
      };
      if (renderMap[tab]) renderMap[tab](data);
    }

    // ========== RENDER FUNCTIONS (IMPLEMENTED) ==========

    function renderDashboard({ products, sales, purchases }) {
        const totalSales = sales.reduce((s, x) => s + Number(x.total || 0), 0);
        const totalPurchases = purchases.reduce((s, x) => s + Number(x.total || 0), 0);
        const receivables = sales.reduce((s, x) => s + (Number(x.total || 0) - Number(x.paid || 0)), 0);
        const payables = purchases.reduce((s, x) => s + (Number(x.total || 0) - Number(x.paid || 0)), 0);
        const lowStock = products.filter(p => Number(p.stock || 0) <= Number(p.minStock || 0));

        main.innerHTML = `
        <h2>Dashboard</h2>
        <div class="card row" style="flex-wrap: wrap;">
          <div class="col" style="background:#eef8f7; padding:16px; border-radius:10px;"><div class="small">Total Sales</div><div class="bold">‚Çπ ${fmt(totalSales)}</div></div>
          <div class="col" style="background:#f0fdf4; padding:16px; border-radius:10px;"><div class="small">Total Purchases</div><div class="bold">‚Çπ ${fmt(totalPurchases)}</div></div>
          <div class="col" style="background:#fff7ed; padding:16px; border-radius:10px;"><div class="small">Receivables</div><div class="bold">‚Çπ ${fmt(receivables)}</div></div>
          <div class="col" style="background:#fff1f2; padding:16px; border-radius:10px;"><div class="small">Payables</div><div class="bold">‚Çπ ${fmt(payables)}</div></div>
        </div>
        <div class="card">
          <h3 style="margin-top:0">Low Stock Alerts</h3>
          ${lowStock.length ? `
            <table><thead><tr><th>SKU</th><th>Product</th><th class="right">Stock</th><th class="right">Min Stock</th></tr></thead>
            <tbody>${lowStock.map(p => `<tr><td>${p.sku}</td><td>${p.name}</td><td class="right">${p.stock} ${p.unit}</td><td class="right">${p.minStock}</td></tr>`).join('')}</tbody>
            </table>` : '<div class="small">No low stock items.</div>'}
        </div>`;
    }

    function renderProducts({ products }) {
        main.innerHTML = `
        <h2>Products & Stock</h2>
        <div class="card">
          <form id="product-form">
            <input type="hidden" id="id">
            <div class="row">
              <div class="col"><label>SKU</label><input id="sku"></div>
              <div class="col"><label>Product Name</label><input id="name" required></div>
              <div class="col"><label>Category</label><input id="category"></div>
            </div>
            <div class="row">
              <div class="col"><label>Sale Price (‚Çπ)</label><input id="price" type="number" step="0.01"></div>
              <div class="col"><label>Cost Price (‚Çπ)</label><input id="cost" type="number" step="0.01"></div>
              <div class="col"><label>Stock</label><input id="stock" type="number"></div>
              <div class="col"><label>Unit</label><input id="unit" placeholder="pcs, kg, etc."></div>
              <div class="col"><label>Min Stock</label><input id="minStock" type="number"></div>
            </div>
            <div class="row" style="justify-content:flex-end; margin-top:12px;">
              <button type="reset" class="btn ghost">Clear</button>
              <button type="submit" class="btn primary">Save Product</button>
            </div>
          </form>
        </div>
        <div class="card">
            <h3>All Products</h3>
            <table><thead><tr><th>SKU</th><th>Name</th><th>Price</th><th>Cost</th><th>Stock</th><th>Actions</th></tr></thead>
            <tbody>
                ${products.map(p => `
                <tr>
                    <td>${p.sku}</td><td>${p.name}</td><td class="right">‚Çπ ${fmt(p.price)}</td><td class="right">‚Çπ ${fmt(p.cost)}</td><td class="right">${p.stock} ${p.unit}</td>
                    <td>
                        <button class="btn" data-id="${p.id}" data-action="edit">Edit</button>
                        <button class="btn danger" data-id="${p.id}" data-action="delete">Del</button>
                    </td>
                </tr>`).join('')}
            </tbody></table>
        </div>`;

        main.querySelector('#product-form').onsubmit = e => {
            e.preventDefault();
            const form = e.target;
            const id = form.id.value;
            const product = {
                id: id || uid('p'), sku: form.sku.value, name: form.name.value, category: form.category.value,
                price: Number(form.price.value), cost: Number(form.cost.value), stock: Number(form.stock.value),
                unit: form.unit.value, minStock: Number(form.minStock.value)
            };
            const allProducts = load('products');
            const existing = allProducts.findIndex(p => p.id === id);
            if (existing !== -1) allProducts[existing] = product;
            else allProducts.unshift(product);
            save('products', allProducts);
            showToast('Product saved');
            render('products');
        };

        main.onclick = e => {
            const btn = e.target.closest('button[data-action]');
            if (!btn) return;
            const { id, action } = btn.dataset;
            if (action === 'edit') {
                const p = load('products').find(p => p.id === id);
                const form = main.querySelector('#product-form');
                Object.keys(p).forEach(key => form[key] && (form[key].value = p[key]));
                form.scrollIntoView();
            } else if (action === 'delete') {
                if (!confirm('Delete this product?')) return;
                const updated = load('products').filter(p => p.id !== id);
                save('products', updated);
                showToast('Product deleted');
                render('products');
            }
        };
    }

    function renderEntity(key, singular, fields) {
        const items = load(key);
        main.innerHTML = `
        <h2>${singular}s</h2>
        <div class="card">
            <form id="entity-form">
                <input type="hidden" id="id">
                ${fields.map(f => `<div class="row"><div class="col"><label>${f.charAt(0).toUpperCase() + f.slice(1)}</label><input id="${f}" ${f==='name'?'required':''}></div></div>`).join('')}
                <div class="row" style="justify-content:flex-end; margin-top:12px;">
                    <button type="reset" class="btn ghost">Clear</button>
                    <button type="submit" class="btn primary">Save ${singular}</button>
                </div>
            </form>
        </div>
        <div class="card">
            <h3>All ${singular}s</h3>
            <table><thead><tr>${fields.map(f => `<th>${f.charAt(0).toUpperCase() + f.slice(1)}</th>`).join('')}<th>Actions</th></tr></thead>
            <tbody>
                ${items.map(item => `
                <tr>
                    ${fields.map(f => `<td>${item[f] || '‚Äì'}</td>`).join('')}
                    <td>
                        <button class="btn" data-id="${item.id}" data-action="edit">Edit</button>
                        <button class="btn danger" data-id="${item.id}" data-action="delete">Del</button>
                    </td>
                </tr>`).join('')}
            </tbody></table>
        </div>`;

        main.querySelector('#entity-form').onsubmit = e => {
            e.preventDefault();
            const form = e.target;
            const id = form.id.value;
            const newItem = { id: id || uid(key[0]) };
            fields.forEach(f => newItem[f] = form[f].value);
            
            const allItems = load(key);
            const existing = allItems.findIndex(i => i.id === id);
            if (existing !== -1) allItems[existing] = newItem;
            else allItems.unshift(newItem);
            save(key, allItems);
            showToast(`${singular} saved`);
            render(key);
        };
        
        main.onclick = e => {
            const btn = e.target.closest('button[data-action]');
            if (!btn) return;
            const { id, action } = btn.dataset;
            if (action === 'edit') {
                const item = load(key).find(i => i.id === id);
                const form = main.querySelector('#entity-form');
                Object.keys(item).forEach(k => form[k] && (form[k].value = item[k]));
                form.scrollIntoView();
            } else if (action === 'delete') {
                if (!confirm(`Delete this ${singular}?`)) return;
                const updated = load(key).filter(i => i.id !== id);
                save(key, updated);
                showToast(`${singular} deleted`);
                render(key);
            }
        };
    }
    
    function renderTransactions(key, singular, partyKey) {
      // For simplicity, this is a read-only list view.
      // A full transaction editor is complex. Payments tab handles dues.
      const items = load(key);
      const parties = load(partyKey);

      main.innerHTML = `
        <h2>${singular}s</h2>
        <div class="card">
          <p class="small">New transactions are created via the "Payments & Receipts" tab. This view is for listing existing records.</p>
          <table>
            <thead><tr><th>Date</th><th>${partyKey === 'customers' ? 'Customer' : 'Supplier'}</th><th>Ref #</th><th class="right">Total</th><th class="right">Due</th></tr></thead>
            <tbody>
              ${items.map(item => {
                const party = parties.find(p => p.id === item.customerId || p.id === item.supplierId) || {};
                const due = (Number(item.total || 0) - Number(item.paid || 0));
                return `
                  <tr>
                    <td>${item.date || 'N/A'}</td>
                    <td>${party.name || 'Unknown'}</td>
                    <td>${item.invoice || item.bill || item.id}</td>
                    <td class="right">‚Çπ ${fmt(item.total)}</td>
                    <td class="right" style="color:${due > 0 ? '#ef4444' : 'inherit'}">‚Çπ ${fmt(due)}</td>
                  </tr>
                `
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderPayments({ payments, sales, purchases, customers, suppliers }) {
      main.innerHTML = `
        <h2>Payments & Receipts</h2>
        <div class="card">
          <div class="row">
            <div class="col"><label>Type</label><select id="pt-type"><option value="receipt">Receipt (From Customer)</option><option value="payment">Payment (To Supplier)</option></select></div>
            <div class="col" style="flex:2;"><label>Reference (Invoice / Bill)</label><select id="pt-ref"></select></div>
            <div class="col"><label>Date</label><input id="pt-date" type="date" value="${today()}"/></div>
          </div>
          <div class="row" style="margin-top:8px">
            <div class="col"><label>Amount (‚Çπ)</label><input id="pt-amt" type="number" step="0.01"/></div>
            <div class="col"><label>Method</label><input id="pt-method" placeholder="Cash/Bank/UPI"/></div>
            <div style="align-self:flex-end;"><button id="pt-save" class="btn primary">Record Payment</button></div>
          </div>
        </div>
        <div class="card">
          <h3>All Payments</h3>
          <table>
            <thead><tr><th>Date</th><th>Type</th><th>Reference</th><th class="right">Amount</th><th>Method</th></tr></thead>
            <tbody id="pt-tbody"></tbody>
          </table>
        </div>`;

      const refSel = document.getElementById('pt-ref');
      const populateRefs = () => {
        refSel.innerHTML = '';
        const type = document.getElementById('pt-type').value;
        if (type === 'receipt') {
          sales.forEach(inv => {
            const cust = customers.find(c => c.id === inv.customerId) || {};
            const due = (Number(inv.total || 0) - Number(inv.paid || 0));
            if (due <= 0) return;
            refSel.innerHTML += `<option value="sale:${inv.id}">Invoice ${inv.invoice || inv.id} (${cust.name}) - Due ‚Çπ ${fmt(due)}</option>`;
          });
        } else {
          purchases.forEach(bill => {
            const sup = suppliers.find(s => s.id === bill.supplierId) || {};
            const due = (Number(bill.total || 0) - Number(bill.paid || 0));
            if (due <= 0) return;
            refSel.innerHTML += `<option value="purchase:${bill.id}">Bill ${bill.bill || bill.id} (${sup.name}) - Due ‚Çπ ${fmt(due)}</option>`;
          });
        }
        if (!refSel.options.length) refSel.innerHTML = '<option value="">No outstanding references</option>';
      };

      document.getElementById('pt-type').onchange = populateRefs;
      populateRefs();

      document.getElementById('pt-save').onclick = () => {
        const ref = document.getElementById('pt-ref').value;
        if (!ref) return showToast('Select a reference');
        const [rType, id] = ref.split(':');
        const amount = Number(document.getElementById('pt-amt').value || 0);
        if (amount <= 0) return showToast('Enter a valid amount');

        const payment = {
          id: uid('pay'), type: rType === 'sale' ? 'receipt' : 'payment',
          refType: rType, refId: id, date: document.getElementById('pt-date').value,
          amount, method: document.getElementById('pt-method').value || 'Cash'
        };
        const allPayments = load('payments');
        allPayments.unshift(payment);
        save('payments', allPayments);

        const collection = rType === 'sale' ? 'sales' : 'purchases';
        const items = load(collection);
        const item = items.find(x => x.id === id);
        if (item) {
          item.paid = (Number(item.paid || 0) + amount);
          save(collection, items);
        }
        showToast('Payment recorded');
        render('payments');
      };

      document.getElementById('pt-tbody').innerHTML = payments.map(pm => {
        let refLabel = '‚Äì';
        if (pm.refType === 'sale') {
          const inv = sales.find(s => s.id === pm.refId);
          const cust = customers.find(c => c.id === inv?.customerId) || {};
          refLabel = inv ? `Inv #${inv.invoice || inv.id} (${cust.name})` : 'Invoice';
        } else if (pm.refType === 'purchase') {
          const bill = purchases.find(b => b.id === pm.refId);
          const sup = suppliers.find(s => s.id === bill?.supplierId) || {};
          refLabel = bill ? `Bill #${bill.bill || bill.id} (${sup.name})` : 'Bill';
        }
        return `<tr><td>${pm.date}</td><td>${pm.type}</td><td>${refLabel}</td><td class="right">‚Çπ ${fmt(pm.amount)}</td><td>${pm.method}</td></tr>`;
      }).join('');
    }

    function renderReports() {
        main.innerHTML = `
        <h2>Reports & Export</h2>
        <div class="card">
            <h3>Export Data</h3>
            <p class="small">Download all your data (products, customers, sales, etc.) as a single JSON file for backup.</p>
            <button id="export-btn" class="btn primary">Export All Data</button>
        </div>
        <div class="card">
            <h3>Import Data</h3>
            <p class="small">Import data from a JSON file. <strong>Warning:</strong> This will overwrite all existing data.</p>
            <textarea id="import-area" rows="8" placeholder="Paste your JSON data here..."></textarea>
            <div style="text-align:right; margin-top:8px;">
                <button id="import-btn" class="btn danger">Import and Overwrite Data</button>
            </div>
        </div>`;

        document.getElementById('export-btn').onclick = () => {
            const allData = LS_KEYS.reduce((acc, key) => ({ ...acc, [key]: load(key) }), {});
            const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sales-purchase-backup-${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data exported');
        };

        document.getElementById('import-btn').onclick = () => {
            const jsonText = document.getElementById('import-area').value;
            if (!jsonText) return showToast('Paste data into the text area first');
            if (!confirm('ARE YOU SURE? This will delete all current data and replace it with the imported data.')) return;
            try {
                const data = JSON.parse(jsonText);
                LS_KEYS.forEach(key => {
                    if (data[key] && Array.isArray(data[key])) {
                        save(key, data[key]);
                    }
                });
                showToast('Data imported successfully!');
                render('dashboard');
            } catch (err) {
                showToast('Import failed. Invalid JSON data.');
            }
        };
    }

    // ========== INIT ==========
    render('dashboard');
  </script>
</body>
</html>
