<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sales & Purchase ‚Äî Fixed</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --accent: #2b7a78;
      --muted: #6b7280;
      --border: #e5e7eb;
      --bg: #f9fafb;
      --card-bg: #ffffff;
      --text: #111827;
      --shadow: rgba(15, 23, 42, 0.06);
    }

    [data-theme="dark"] {
      --accent: #14a8a5;
      --muted: #9ca3af;
      --border: #374151;
      --bg: #111827;
      --card-bg: #1f2937;
      --text: #f3f4f6;
      --shadow: rgba(0, 0, 0, 0.2);
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s ease;
    }

    header {
      background: var(--accent);
      color: white;
      padding: 14px 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    header h1 { font-size: 18px; font-weight: 600; margin: 0; }
    .wrap { display: flex; gap: 16px; padding: 16px; align-items: flex-start; }
    nav { width: 260px; background: var(--card-bg); padding: 12px; border-radius: 12px; box-shadow: 0 6px 18px var(--shadow); }
    nav button { display: flex; gap: 10px; align-items: center; width: 100%; padding: 10px 12px; border-radius: 8px; border: none; background: transparent; cursor: pointer; color: #0f172a; font-size: 14px; text-align: left; transition: all 0.2s; }
    nav button:hover { background: rgba(43, 122, 120, 0.08); }
    nav button.active { background: linear-gradient(90deg, rgba(43,122,120,.1), rgba(43,122,120,.05)); font-weight: 600; color: var(--accent); }
    main { flex: 1; background: var(--card-bg); padding: 16px; border-radius: 12px; box-shadow: 0 6px 18px var(--shadow); }
    h2 { margin: 0 0 16px 0; font-size: 20px; font-weight: 600; }
    .row { display: flex; gap: 12px; margin-bottom: 8px; flex-wrap: wrap; }
    input, select, textarea, button { font-family: inherit; font-size: 14px; }
    input, select, textarea { padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text); width: 100%; }
    input:focus, select:focus, textarea:focus { outline: 2px solid var(--accent); border-color: var(--accent); }
    button.btn { padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: 500; }
    button.primary { background: var(--accent); color: white; } button.ghost { background: transparent; border: 1px solid var(--border); } button.danger { background: #ef4444; color: white; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { padding: 10px; border-bottom: 1px solid var(--border); text-align: left; }
    th { background: rgba(43, 122, 120, 0.05); font-weight: 600; }
    .right { text-align: right; } .center { text-align: center; } .small { font-size: 12px; color: var(--muted); } .bold { font-weight: 600; }
    .card { background: var(--card-bg); padding: 16px; border-radius: 10px; box-shadow: 0 2px 6px rgba(2,6,23,.03); margin-bottom: 16px; }
    .toast { position: fixed; top: 20px; right: 20px; padding: 12px 16px; border-radius: 8px; background: #333; color: white; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; transform: translateY(-10px); transition: all 0.3s ease; }
    .toast.show { opacity: 1; transform: translateY(0); }
    footer { padding: 16px; text-align: center; color: var(--muted); font-size: 13px; }
    .theme-toggle { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 10px; border-radius: 8px; cursor: pointer; }
    @media (max-width: 880px) { .wrap { flex-direction: column; } nav { width: 100%; } }
  </style>
</head>
<body>
  <header>
    <h1>Sales & Purchase Management ‚Äî Fixed</h1>
    <button class="theme-toggle" onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>
  </header>

  <div class="wrap">
    <nav id="nav">
      <button data-tab="dashboard" class="active">Dashboard</button>
      <button data-tab="products">Products & Stock</button>
      <button data-tab="customers">Customers</button>
      <button data-tab="suppliers">Suppliers</button>
      <button data-tab="sales">Sales Invoices</button>
      <button data-tab="purchases">Purchase Bills</button>
      <button data-tab="payments">Payments & Receipts</button>
      <button data-tab="reports">Reports & Export</button>
    </nav>

    <main id="main"></main>
  </div>

  <footer>Fully offline. Data saved in browser. Export/Import JSON in Reports.</footer>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script>
    // ========== TOAST ==========
    function showToast(msg, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.className = 'toast show';
      setTimeout(() => { toast.className = 'toast'; }, 3000);
    }

    // ========== THEME ==========
    function toggleTheme() {
      const root = document.documentElement;
      const isDark = root.getAttribute('data-theme') === 'dark';
      root.setAttribute('data-theme', isDark ? 'light' : 'dark');
      localStorage.setItem('theme', isDark ? 'light' : 'dark');
    }

    if (localStorage.getItem('theme') === 'dark') {
      document.documentElement.setAttribute('data-theme', 'dark');
    }

    // ========== UTILS ==========
    const uid = (p = 'id') => p + Date.now().toString(36) + Math.random().toString(36).slice(2,6);
    const fmt = n => Number(n || 0).toLocaleString('en-IN', { maximumFractionDigits: 2 });
    const today = () => new Date().toISOString().slice(0,10);

    const LS_KEYS = ['products','customers','suppliers','sales','purchases','payments'];

    function load(key) { try { return JSON.parse(localStorage.getItem(key) || '[]'); } catch { return []; } }
    function save(key, arr) { localStorage.setItem(key, JSON.stringify(arr || [])); }

    function initIfEmpty() {
      if (!load('products').length) save('products', [
        {id:uid('p'), sku:'P-001', name:'Widget A', category:'General', price:100, cost:70, stock:50, unit:'pcs', minStock:5},
        {id:uid('p'), sku:'P-002', name:'Widget B', category:'General', price:200, cost:140, stock:30, unit:'pcs', minStock:5}
      ]);
      if (!load('customers').length) save('customers', [{id:uid('c'), name:'Walk-in Customer', phone:'', email:''}]);
      if (!load('suppliers').length) save('suppliers', []);
      if (!load('sales').length) save('sales', []);
      if (!load('purchases').length) save('purchases', []);
      if (!load('payments').length) save('payments', []);
    }

    initIfEmpty();

    // ========== NAV ==========
    const nav = document.getElementById('nav');
    const main = document.getElementById('main');

    // Use event delegation but be robust to clicks on inner elements
    nav.addEventListener('click', e => {
      const btn = e.target.closest('button[data-tab]');
      if (!btn) return;
      document.querySelectorAll('#nav button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      render(btn.dataset.tab);
    });

    function render(tab = 'dashboard') {
      const data = LS_KEYS.reduce((acc, k) => ({ ...acc, [k]: load(k) }), {});
      if (tab === 'dashboard') renderDashboard(data);
      else if (tab === 'products') renderProducts(data);
      else if (tab === 'customers') renderCustomers(data);
      else if (tab === 'suppliers') renderSuppliers(data);
      else if (tab === 'sales') renderSales(data);
      else if (tab === 'purchases') renderPurchases(data);
      else if (tab === 'payments') renderPayments(data);
      else if (tab === 'reports') renderReports(data);
    }

    // ========== (Other render functions unchanged except payments) ==========
    function renderDashboard({ products, sales, purchases, payments }) {
      const totalSales = sales.reduce((s,x) => s + Number(x.total||0), 0);
      const totalPurchases = purchases.reduce((s,x) => s + Number(x.total||0), 0);
      const receivables = sales.reduce((s,x) => s + Number(x.due||0), 0);
      const payables = purchases.reduce((s,x) => s + Number(x.due||0), 0);
      const lowStock = products.filter(p => Number(p.stock||0) <= Number(p.minStock||0));

      main.innerHTML = `
        <h2>Dashboard</h2>
        <div class="card row">
          <div style="flex:1;min-width:200px;padding:16px;border-radius:10px;background:#eef8f7"><div class="small">Total Sales</div><div class="bold">‚Çπ ${fmt(totalSales)}</div></div>
          <div style="flex:1;min-width:200px;padding:16px;border-radius:10px;background:#f0fdf4"><div class="small">Total Purchases</div><div class="bold">‚Çπ ${fmt(totalPurchases)}</div></div>
          <div style="flex:1;min-width:200px;padding:16px;border-radius:10px;background:#fff7ed"><div class="small">Receivables</div><div class="bold">‚Çπ ${fmt(receivables)}</div></div>
          <div style="flex:1;min-width:200px;padding:16px;border-radius:10px;background:#fff1f2"><div class="small">Payables</div><div class="bold">‚Çπ ${fmt(payables)}</div></div>
        </div>
        <div class="card">
          <h3 style="margin-top:0">Low Stock Alerts</h3>
          ${lowStock.length ? `
            <table>
              <thead><tr><th>SKU</th><th>Product</th><th>Stock</th><th>Min</th></tr></thead>
              <tbody>${lowStock.map(p => `
                <tr><td>${p.sku}</td><td>${p.name}</td><td class="right">${p.stock} ${p.unit}</td><td class="right">${p.minStock}</td></tr>
              `).join('')}</tbody>
            </table>
          ` : '<div class="small">No low stock items</div>'}
        </div>
      `;
    }

    // For brevity, copy the products/customers/suppliers renderers from original file (they were fine). -- Products
    function renderProducts({ products }) {
      main.innerHTML = `...`;
      // original implementation kept when running in the real file
      // For this fixed demo we re-render by calling the original file's method in your project.
      // In the canvas preview we keep code concise. When you paste this file into your project, replace `...` with the original renderProducts body from your file (unchanged).
    }

    function renderCustomers({ customers }) { main.innerHTML = `...`; }
    function renderSuppliers({ suppliers }) { main.innerHTML = `...`; }
    function renderSales() { main.innerHTML = `<h2>Sales (placeholder)</h2>`; }
    function renderPurchases() { main.innerHTML = `<h2>Purchases (placeholder)</h2>`; }
    function renderReports() { main.innerHTML = `<h2>Reports (placeholder)</h2>`; }

    // ========== PAYMENTS (FIXED: clearer labels + no variable shadowing) ==========
    function renderPayments({ payments, sales, purchases, customers, suppliers }) {
      main.innerHTML = `
        <h2>Payments & Receipts</h2>
        <div class="card">
          <div class="row">
            <div style="flex:1"><label>Type</label><select id="pt-type"><option value="receipt">Receipt (Customer)</option><option value="payment">Payment (Supplier)</option></select></div>
            <div style="flex:2"><label>Reference</label><select id="pt-ref"></select></div>
            <div style="flex:1"><label>Date</label><input id="pt-date" type="date" value="${today()}"/></div>
          </div>
          <div class="row" style="margin-top:8px">
            <div style="flex:1"><label>Amount (‚Çπ)</label><input id="pt-amt" type="number" step="0.01"/></div>
            <div style="flex:1"><label>Method</label><input id="pt-method" placeholder="Cash/Bank/UPI"/></div>
            <div><button id="pt-save" class="btn primary">Record</button></div>
          </div>
        </div>
        <div class="card">
          <h3>All Payments</h3>
          <table>
            <thead><tr><th>Date</th><th>Type</th><th>Reference</th><th class="right">Amount</th><th>Method</th></tr></thead>
            <tbody id="pt-tbody"></tbody>
          </table>
        </div>
      `;

      const refSel = document.getElementById('pt-ref');
      const populateRefs = () => {
        refSel.innerHTML = '';
        const type = document.getElementById('pt-type').value;

        if (type === 'receipt') {
          // Show outstanding sales with explicit customer label
          sales.forEach(inv => {
            const cust = customers.find(c => c.id === inv.customerId) || {};
            const due = (Number(inv.total || 0) - Number(inv.paid || 0));
            if (due <= 0) return;
            const label = `Invoice ${inv.invoice || inv.id} ‚Äî Customer: ${cust.name || 'Unknown'} (Due ‚Çπ ${fmt(due)})`;
            refSel.innerHTML += `<option value="sale:${inv.id}">${label}</option>`;
          });
        } else {
          // Show outstanding purchases with explicit supplier label
          purchases.forEach(bill => {
            const sup = suppliers.find(s => s.id === bill.supplierId) || {};
            const due = (Number(bill.total || 0) - Number(bill.paid || 0));
            if (due <= 0) return;
            const label = `Bill ${bill.bill || bill.id} ‚Äî Supplier: ${sup.name || 'Unknown'} (Due ‚Çπ ${fmt(due)})`;
            refSel.innerHTML += `<option value="purchase:${bill.id}">${label}</option>`;
          });
        }

        if (!refSel.options.length) {
          refSel.innerHTML = '<option value="">No outstanding references</option>';
        }
      };

      document.getElementById('pt-type').onchange = populateRefs;
      populateRefs(); // Initial load

      document.getElementById('pt-save').onclick = () => {
        const ref = document.getElementById('pt-ref').value;
        if (!ref) return showToast('Select reference', 'error');
        const [rType, id] = ref.split(':');
        const amount = Number(document.getElementById('pt-amt').value || 0);
        if (amount <= 0) return showToast('Enter valid amount', 'error');

        const payment = {
          id: uid('pay'),
          type: rType === 'sale' ? 'receipt' : 'payment',
          refType: rType,
          refId: id,
          date: document.getElementById('pt-date').value,
          amount,
          method: document.getElementById('pt-method').value || 'Cash'
        };

        const arr = load('payments');
        arr.unshift(payment);
        save('payments', arr);

        // Update due amount safely
        if (rType === 'sale') {
          const sArr = load('sales');
          const s = sArr.find(x => x.id === id);
          if (s) {
            s.paid = (Number(s.paid || 0) + amount);
            s.due = Number(s.total || 0) - s.paid;
            save('sales', sArr.map(x => x.id === id ? s : x));
          }
        } else if (rType === 'purchase') {
          const pArr = load('purchases');
          const p = pArr.find(x => x.id === id);
          if (p) {
            p.paid = (Number(p.paid || 0) + amount);
            p.due = Number(p.total || 0) - p.paid;
            save('purchases', pArr.map(x => x.id === id ? p : x));
          }
        }

        showToast('Payment recorded');
        render('payments');
      };

      // List all payments with correct labels (avoid variable shadowing)
      const tb = document.getElementById('pt-tbody');
      tb.innerHTML = payments.map(pm => {
        let refLabel = '‚Äì';
        if (pm.refType === 'sale') {
          const inv = sales.find(s => s.id === pm.refId);
          const cust = customers.find(c => c.id === inv?.customerId) || {};
          refLabel = inv ? `${inv.invoice || inv.id} ‚Äî Customer: ${cust.name || 'Unknown'}` : 'Invoice';
        } else if (pm.refType === 'purchase') {
          const bill = purchases.find(b => b.id === pm.refId);
          const sup = suppliers.find(s => s.id === bill?.supplierId) || {};
          refLabel = bill ? `${bill.bill || bill.id} ‚Äî Supplier: ${sup.name || 'Unknown'}` : 'Bill';
        }
        return `
          <tr>
            <td>${pm.date}</td>
            <td>${pm.type}</td>
            <td>${refLabel}</td>
            <td class="right">‚Çπ ${fmt(pm.amount)}</td>
            <td>${pm.method}</td>
          </tr>
        `;
      }).join('');
    }

    // ========== INIT ==========
    render('dashboard');
  </script>
</body>
</html>
