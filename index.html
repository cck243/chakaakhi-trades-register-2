<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sales & Purchase Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- jsPDF and html2canvas for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --accent: #2b7a78; --muted: #6b7280; --border: #e5e7eb; --bg: #f9fafb;
      --card-bg: #ffffff; --text: #111827; --shadow: rgba(15, 23, 42, 0.06);
    }
    [data-theme="dark"] {
      --accent: #14a8a5; --muted: #9ca3af; --border: #374151; --bg: #111827;
      --card-bg: #1f2937; --text: #f3f4f6; --shadow: rgba(0, 0, 0, 0.2);
    }
    body { font-family: 'Inter', system-ui, sans-serif; margin: 0; background: var(--bg); color: var(--text); transition: background 0.3s ease; font-size: 14px; }
    header { background: var(--accent); color: white; padding: 14px 18px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    header h1 { font-size: 18px; font-weight: 600; margin: 0; }
    .wrap { display: flex; gap: 16px; padding: 16px; align-items: flex-start; }
    nav { width: 260px; background: var(--card-bg); padding: 12px; border-radius: 12px; box-shadow: 0 6px 18px var(--shadow); }
    nav button { display: flex; gap: 10px; align-items: center; width: 100%; padding: 10px 12px; border-radius: 8px; border: none; background: transparent; cursor: pointer; color: var(--text); font-size: 14px; text-align: left; transition: all 0.2s; }
    nav button:hover { background: rgba(43, 122, 120, 0.08); }
    nav button.active { background: linear-gradient(90deg, rgba(43,122,120,.1), rgba(43,122,120,.05)); font-weight: 600; color: var(--accent); }
    main { flex: 1; background: var(--card-bg); padding: 16px; border-radius: 12px; box-shadow: 0 6px 18px var(--shadow); }
    h2 { margin: 0 0 16px 0; font-size: 20px; font-weight: 600; }
    .row { display: flex; gap: 12px; margin-bottom: 8px; flex-wrap: wrap; }
    label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 4px; }
    input, select, textarea, button { font-family: inherit; font-size: 14px; }
    input, select, textarea { padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); width: 100%; box-sizing: border-box; }
    input:focus, select:focus, textarea:focus { outline: 2px solid var(--accent); border-color: var(--accent); }
    button.btn { padding: 10px 14px; border-radius: 8px; border: none; cursor: pointer; font-weight: 500; transition: background 0.2s; }
    button.primary { background: var(--accent); color: white; } button.primary:hover { background: #3aa19f; }
    button.ghost { background: transparent; border: 1px solid var(--border); color: var(--text); } button.ghost:hover { background: var(--bg); }
    button.danger { background: #ef4444; color: white; } button.danger:hover { background: #f87171; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { padding: 10px; border-bottom: 1px solid var(--border); text-align: left; font-size: 14px; }
    th { background: var(--bg); font-weight: 600; }
    .right { text-align: right; } .center { text-align: center; } .small { font-size: 12px; color: var(--muted); } .bold { font-weight: 600; }
    .card { background: var(--card-bg); padding: 16px; border-radius: 10px; box-shadow: 0 4px 12px var(--shadow); margin-bottom: 16px; }
    .toast { position: fixed; top: 20px; right: 20px; padding: 12px 16px; border-radius: 8px; background: #333; color: white; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; transform: translateY(-10px); transition: all 0.3s ease; }
    .toast.show { opacity: 1; transform: translateY(0); }
    footer { padding: 16px; text-align: center; color: var(--muted); font-size: 13px; }
    .theme-toggle { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 10px; border-radius: 8px; cursor: pointer; }
    .invoice-view { padding: 24px; }
    .invoice-header { display: flex; justify-content: space-between; margin-bottom: 24px; flex-wrap: wrap; gap: 20px; }
    .invoice-header div { flex: 1; min-width: 200px; }
    .invoice-header h3 { margin: 0 0 8px 0; color: var(--accent); }
    .invoice-header p { margin: 0; line-height: 1.6; }
    .invoice-actions { display: flex; justify-content: flex-end; gap: 8px; padding: 16px 0; }
    @media (max-width: 880px) { .wrap { flex-direction: column; } nav { width: 100%; } }
    @media (max-width: 600px) {
        body { font-size: 13px; }
        .row { flex-direction: column; gap: 8px; margin-bottom: 12px; }
        .row > div { width: 100% !important; }
        .invoice-actions { flex-direction: column; }
        .invoice-actions .btn { width: 100%; }
        header h1 { font-size: 16px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Sales & Purchase Pro</h1>
    <button class="theme-toggle" onclick="toggleTheme()">� / ☀️</button>
  </header>

  <div class="wrap">
    <nav id="nav">
      <button data-tab="dashboard" class="active">Dashboard</button>
      <button data-tab="products">Products & Stock</button>
      <button data-tab="customers">Customers</button>
      <button data-tab="suppliers">Suppliers</button>
      <button data-tab="sales">Sales Invoices</button>
      <button data-tab="purchases">Purchase Bills</button>
      <button data-tab="payments">Payments & Receipts</button>
      <button data-tab="reports">Reports & Export</button>
      <button data-tab="settings">Settings</button>
    </nav>
    <main id="main"></main>
  </div>

  <footer>Fully offline. Data saved in browser. Export/Import JSON in Reports.</footer>
  <div id="toast" class="toast"></div>

  <script>
    const { jsPDF } = window.jspdf;
    const main = document.getElementById('main');
    const nav = document.getElementById('nav');

    // ========== UTILS & CORE ==========
    const uid = (p = 'id') => p + Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
    const fmt = n => Number(n || 0).toLocaleString('en-IN', { maximumFractionDigits: 2, minimumFractionDigits: 2 });
    const today = () => new Date().toISOString().slice(0, 10);
    const LS_KEYS = ['products', 'customers', 'suppliers', 'sales', 'purchases', 'payments', 'companyDetails'];

    function load(key) { try { return JSON.parse(localStorage.getItem(key) || '[]'); } catch { return key === 'companyDetails' ? {} : []; } }
    function save(key, data) { localStorage.setItem(key, JSON.stringify(data || (key === 'companyDetails' ? {} : []))); }
    function getSetting(key) { const settings = load('companyDetails'); return settings[key] || ''; }
    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.className = 'toast show';
        setTimeout(() => { toast.className = 'toast'; }, 3000);
    }
    function toggleTheme() {
        const root = document.documentElement;
        const isDark = root.getAttribute('data-theme') === 'dark';
        root.setAttribute('data-theme', isDark ? 'light' : 'dark');
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
    }

    // ========== INITIAL DATA SETUP ==========
    function initIfEmpty() {
        if (!load('products').length) save('products', [
            { id: uid('p'), sku: 'P-001', name: 'Widget A', category: 'General', price: 100, cost: 70, stock: 50, unit: 'pcs', minStock: 5 },
            { id: uid('p'), sku: 'P-002', name: 'Widget B', category: 'General', price: 200, cost: 140, stock: 30, unit: 'pcs', minStock: 5 }
        ]);
        if (!load('customers').length) save('customers', [{ id: uid('c'), name: 'Walk-in Customer', phone: '', email: '' }]);
        LS_KEYS.forEach(k => { if (!localStorage.getItem(k)) save(k, k === 'companyDetails' ? {} : []); });
    }

    // ========== NAVIGATION & ROUTING ==========
    nav.addEventListener('click', e => {
        const btn = e.target.closest('button[data-tab]');
        if (!btn) return;
        nav.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        render(btn.dataset.tab);
    });

    function render(tab, id) {
        const data = LS_KEYS.reduce((acc, k) => ({ ...acc, [k]: load(k) }), {});
        const renderer = {
            dashboard: renderDashboard,
            products: renderProducts,
            customers: renderCustomers,
            suppliers: renderSuppliers,
            sales: renderSales,
            new_sale: renderSaleForm,
            view_sale: renderSaleView,
            purchases: renderPurchases,
            new_purchase: renderPurchaseForm,
            view_purchase: renderPurchaseView,
            payments: renderPayments,
            reports: renderReports,
            settings: renderSettings,
        }[tab];
        if (renderer) renderer(data, id);
    }

    // ========== RENDER: DASHBOARD ==========
    function renderDashboard({ products, sales, purchases }) {
      const totalSales = sales.reduce((s,x) => s + Number(x.total||0), 0);
      const totalPurchases = purchases.reduce((s,x) => s + Number(x.total||0), 0);
      const receivables = sales.reduce((s,x) => s + (Number(x.total||0) - Number(x.paid||0)), 0);
      const payables = purchases.reduce((s,x) => s + (Number(x.total||0) - Number(x.paid||0)), 0);
      const lowStock = products.filter(p => Number(p.stock||0) <= Number(p.minStock||0));
      main.innerHTML = `
        <h2>Dashboard</h2>
        <div class="card row" style="gap:16px;">
          <div style="flex:1;min-width:200px;padding:16px;border-radius:10px;background:#eef8f7"><div class="small">Total Sales</div><div class="bold" style="font-size:24px;">₹ ${fmt(totalSales)}</div></div>
          <div style="flex:1;min-width:200px;padding:16px;border-radius:10px;background:#f0fdf4"><div class="small">Total Purchases</div><div class="bold" style="font-size:24px;">₹ ${fmt(totalPurchases)}</div></div>
          <div style="flex:1;min-width:200px;padding:16px;border-radius:10px;background:#fff7ed"><div class="small">Receivables</div><div class="bold" style="font-size:24px;">₹ ${fmt(receivables)}</div></div>
          <div style="flex:1;min-width:200px;padding:16px;border-radius:10px;background:#fff1f2"><div class="small">Payables</div><div class="bold" style="font-size:24px;">₹ ${fmt(payables)}</div></div>
        </div>
        <div class="card">
          <h3 style="margin-top:0">Low Stock Alerts</h3>
          ${lowStock.length ? `<table><thead><tr><th>SKU</th><th>Product</th><th class="right">Stock</th><th class="right">Min Stock</th></tr></thead><tbody>${lowStock.map(p => `
                <tr><td>${p.sku}</td><td>${p.name}</td><td class="right">${p.stock} ${p.unit}</td><td class="right">${p.minStock}</td></tr>`).join('')}</tbody></table>`
                 : '<div class="small">No low stock items</div>'}
        </div>`;
    }

    // ========== RENDER: GENERIC CRUD (FOR PRODUCTS, CUSTOMERS, SUPPLIERS) ==========
    function renderCRUD(opts) {
        const items = load(opts.key);
        main.innerHTML = `
            <h2>${opts.title}</h2>
            <div class="card">
                <form id="crud-form">
                    <input type="hidden" name="id">
                    <div class="row">${opts.fields.map(f => `<div style="flex:${f.flex||1}"><label>${f.label}</label><input name="${f.name}" type="${f.type||'text'}" placeholder="${f.placeholder||''}"></div>`).join('')}</div>
                    <div class="row" style="justify-content:flex-end; margin-top:16px;">
                      <button type="button" class="btn ghost" onclick="this.closest('form').reset()">Clear</button>
                      <button type="submit" class="btn primary">Save ${opts.singular}</button>
                    </div>
                </form>
            </div>
            <div class="card">
                <h3>All ${opts.title}</h3>
                <div style="overflow-x:auto;">
                <table>
                    <thead><tr>${opts.headers.map(h => `<th>${h}</th>`).join('')}<th>Actions</th></tr></thead>
                    <tbody>${items.map(it => `<tr>${opts.row(it).map(td => `<td>${td}</td>`).join('')}
                        <td><button class="btn ghost small" onclick="editItem('${opts.key}', '${it.id}')">Edit</button> <button class="btn danger small" onclick="deleteItem('${opts.key}', '${it.id}')">Del</button></td>
                    </tr>`).join('')}</tbody>
                </table>
                </div>
            </div>`;

        document.getElementById('crud-form').onsubmit = e => {
            e.preventDefault();
            const form = e.target;
            const item = Object.fromEntries(new FormData(form));
            const allItems = load(opts.key);
            if (item.id) { // Update
                save(opts.key, allItems.map(i => i.id === item.id ? { ...i, ...item } : i));
            } else { // Create
                item.id = uid(opts.key[0]);
                allItems.unshift(item);
                save(opts.key, allItems);
            }
            showToast(`${opts.singular} saved.`);
            render(opts.key);
        };
    }

    window.editItem = (key, id) => {
        const item = load(key).find(i => i.id === id);
        if (!item) return;
        const form = document.getElementById('crud-form');
        for (const prop in item) {
            if (form.elements[prop]) form.elements[prop].value = item[prop];
        }
        window.scrollTo(0, 0);
    }
    window.deleteItem = (key, id) => {
        if (!confirm('Are you sure you want to delete this item?')) return;
        save(key, load(key).filter(i => i.id !== id));
        showToast('Item deleted.');
        render(key);
    }

    // ========== RENDER: PRODUCTS, CUSTOMERS, SUPPLIERS (USING GENERIC CRUD) ==========
    function renderProducts() {
        renderCRUD({
            key: 'products', title: 'Products & Stock', singular: 'Product',
            fields: [
                { name: 'sku', label: 'SKU', flex: 1 }, { name: 'name', label: 'Product Name', flex: 2 },
                { name: 'price', label: 'Sale Price (₹)', type: 'number', flex: 1 }, { name: 'cost', label: 'Cost Price (₹)', type: 'number', flex: 1 },
                { name: 'stock', label: 'Stock', type: 'number', flex: 1 }, { name: 'minStock', label: 'Min Stock', type: 'number', flex: 1 },
                { name: 'unit', label: 'Unit (pcs, kg)', flex: 1 },
            ],
            headers: ['SKU', 'Name', 'Sale Price', 'Cost', 'Stock'],
            row: p => [p.sku, p.name, `₹ ${fmt(p.price)}`, `₹ ${fmt(p.cost)}`, `${p.stock||0} ${p.unit||''}`]
        });
    }
    function renderCustomers() {
        renderCRUD({
            key: 'customers', title: 'Customers', singular: 'Customer',
            fields: [ { name: 'name', label: 'Name', flex: 2 }, { name: 'phone', label: 'Phone', flex: 1 }, { name: 'email', label: 'Email', flex: 1 } ],
            headers: ['Name', 'Phone', 'Email'], row: c => [c.name, c.phone, c.email]
        });
    }
    function renderSuppliers() {
        renderCRUD({
            key: 'suppliers', title: 'Suppliers', singular: 'Supplier',
            fields: [ { name: 'name', label: 'Name', flex: 2 }, { name: 'phone', label: 'Phone', flex: 1 }, { name: 'email', label: 'Email', flex: 1 } ],
            headers: ['Name', 'Phone', 'Email'], row: s => [s.name, s.phone, s.email]
        });
    }
    
    // ========== RENDER: SALES LIST ==========
    function renderSales({ sales, customers }) {
      main.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <h2>Sales Invoices</h2>
          <button class="btn primary" onclick="render('new_sale')">New Invoice</button>
        </div>
        <div class="card">
          <div style="overflow-x:auto;">
          <table>
            <thead><tr><th>Date</th><th>Invoice #</th><th>Customer</th><th class="right">Total</th><th class="right">Due</th><th>Actions</th></tr></thead>
            <tbody>
              ${sales.map(s => {
                const cust = customers.find(c => c.id === s.customerId)?.name || 'N/A';
                const due = (s.total || 0) - (s.paid || 0);
                return `<tr style="cursor:pointer;" onclick="render('view_sale', '${s.id}')">
                  <td>${s.date}</td>
                  <td>${s.invoice}</td>
                  <td>${cust}</td>
                  <td class="right">₹ ${fmt(s.total)}</td>
                  <td class="right" style="color:${due > 0.01 ? '#ef4444' : 'inherit'}">₹ ${fmt(due)}</td>
                  <td onclick="event.stopPropagation()"><button class="btn ghost small" onclick="render('new_sale', '${s.id}')">Edit</button></td>
                </tr>`
              }).join('')}
            </tbody>
          </table>
          </div>
        </div>`;
    }
    
    // ========== RENDER: NEW/EDIT SALE FORM ==========
    function renderSaleForm({ products, customers }, saleId) {
        const allSales = load('sales');
        let sale = saleId ? allSales.find(s => s.id === saleId) : null;
        const originalSale = sale ? JSON.parse(JSON.stringify(sale)) : null; // Deep copy for stock calculation
        if (!sale) sale = { id: '', date: today(), invoice: `INV-${Date.now()}`, customerId: '', items: [], total: 0, paid: 0 };

        main.innerHTML = `
            <h2>${saleId ? 'Edit' : 'New'} Sales Invoice</h2>
            <div class="card">
                <form id="sale-form">
                    <div class="row">
                        <div style="flex:1"><label>Customer</label><select name="customerId" required>${customers.map(c => `<option value="${c.id}" ${c.id === sale.customerId ? 'selected' : ''}>${c.name}</option>`).join('')}</select></div>
                        <div style="flex:1"><label>Invoice #</label><input name="invoice" value="${sale.invoice}" required></div>
                        <div style="flex:1"><label>Date</label><input name="date" type="date" value="${sale.date}" required></div>
                    </div>
                </form>
            </div>
            <div class="card">
                <h3>Add Products</h3>
                <div class="row">
                    <div style="flex:3"><label>Product</label><select id="item-product">${products.map(p => `<option value="${p.id}" data-price="${p.price}">${p.name} (Stock: ${p.stock})</option>`).join('')}</select></div>
                    <div style="flex:1"><label>Quantity</label><input id="item-qty" type="number" value="1"></div>
                    <div style="flex:1"><label>Price (₹)</label><input id="item-price" type="number" step="0.01"></div>
                    <div style="margin-top:21px;"><button type="button" class="btn primary" id="add-item-btn">Add</button></div>
                </div>
                <div style="overflow-x:auto;">
                <table id="sale-items-table">
                    <thead><tr><th>Product</th><th class="right">Qty</th><th class="right">Price</th><th class="right">Amount</th><th></th></tr></thead>
                    <tbody></tbody>
                </table>
                </div>
            </div>
            <div class="card row" style="justify-content: flex-end;">
                <div style="width:250px;">
                    <div class="row small" style="justify-content:space-between"><span>Subtotal:</span> <span id="subtotal">₹ 0.00</span></div>
                    <div class="row bold" style="justify-content:space-between;font-size:18px; margin-top:8px;"><span>Total:</span> <span id="total">₹ 0.00</span></div>
                    <div class="row" style="margin-top:8px;"><label>Amount Paid</label><input id="amount-paid" type="number" step="0.01" value="${sale.paid || 0}"></div>
                    <div class="row" style="justify-content:space-between; margin-top:8px;"><span>Due:</span> <span id="due">₹ 0.00</span></div>
                </div>
            </div>
            <div class="row" style="justify-content:flex-end; gap:8px;">
                <button class="btn ghost" onclick="render('sales')">Cancel</button>
                <button class="btn primary" id="save-sale-btn">Save Invoice</button>
            </div>
        `;

        let items = [...(sale.items || [])];
        const productSel = document.getElementById('item-product');
        const priceInput = document.getElementById('item-price');
        const updatePrice = () => priceInput.value = productSel.options[productSel.selectedIndex].dataset.price;
        productSel.onchange = updatePrice;
        updatePrice();

        const updateTotals = () => {
            let sub = items.reduce((acc, i) => acc + i.qty * i.price, 0);
            document.getElementById('subtotal').textContent = `₹ ${fmt(sub)}`;
            document.getElementById('total').textContent = `₹ ${fmt(sub)}`;
            let paid = Number(document.getElementById('amount-paid').value) || 0;
            document.getElementById('due').textContent = `₹ ${fmt(sub - paid)}`;
        };
        const renderItems = () => {
            const tbody = document.getElementById('sale-items-table').querySelector('tbody');
            tbody.innerHTML = items.map((item, index) => {
                const p = products.find(pr => pr.id === item.productId);
                return `<tr>
                    <td>${p ? p.name : 'N/A'}</td>
                    <td class="right">${item.qty}</td>
                    <td class="right">₹ ${fmt(item.price)}</td>
                    <td class="right">₹ ${fmt(item.qty * item.price)}</td>
                    <td class="center"><button type="button" class="btn danger small" onclick="window.removeItem(${index})">X</button></td>
                </tr>`;
            }).join('');
            updateTotals();
        };

        window.removeItem = (index) => {
            items.splice(index, 1);
            renderItems();
        };

        document.getElementById('add-item-btn').onclick = () => {
            const productId = document.getElementById('item-product').value;
            const qty = Number(document.getElementById('item-qty').value);
            const price = Number(document.getElementById('item-price').value);
            if (!productId || qty <= 0 || price < 0) return showToast('Invalid item details');
            items.push({ productId, qty, price });
            renderItems();
            document.getElementById('item-qty').value = 1; // reset
        };
        
        document.getElementById('amount-paid').oninput = updateTotals;

        document.getElementById('save-sale-btn').onclick = () => {
            const prods = load('products');
            const formData = new FormData(document.getElementById('sale-form'));
            const newSale = {
                id: sale.id || uid('s'),
                customerId: formData.get('customerId'),
                invoice: formData.get('invoice'),
                date: formData.get('date'),
                items,
                total: items.reduce((acc, i) => acc + i.qty * i.price, 0),
                paid: Number(document.getElementById('amount-paid').value)
            };

            // --- CRITICAL: Stock Update Logic ---
            // 1. If editing, revert stock from the original sale
            if (originalSale) {
                originalSale.items.forEach(item => {
                    const pIndex = prods.findIndex(p => p.id === item.productId);
                    if (pIndex > -1) prods[pIndex].stock = (prods[pIndex].stock || 0) + item.qty;
                });
            }
            // 2. Apply stock changes for the new/updated sale
            newSale.items.forEach(item => {
                const pIndex = prods.findIndex(p => p.id === item.productId);
                if (pIndex > -1) {
                    if (prods[pIndex].stock < item.qty) {
                       showToast(`Not enough stock for ${prods[pIndex].name}. Available: ${prods[pIndex].stock}`);
                       // Re-add the reverted stock if transaction fails
                       if(originalSale) {
                           originalSale.items.forEach(revertItem => {
                               const pIdx = prods.findIndex(p => p.id === revertItem.productId);
                               if (pIdx > -1) prods[pIdx].stock = (prods[pIdx].stock || 0) - revertItem.qty;
                           });
                       }
                       return; // Stop execution
                    }
                    prods[pIndex].stock -= item.qty;
                }
            });
            save('products', prods);
            
            if (sale.id) { // update existing
                save('sales', allSales.map(s => s.id === sale.id ? newSale : s));
            } else { // add new
                allSales.unshift(newSale);
                save('sales', allSales);
            }
            showToast('Sale saved!');
            render('view_sale', newSale.id);
        };
        renderItems();
    }
    
    // ========== RENDER: PURCHASES (similar to Sales) ==========
    function renderPurchases({ purchases, suppliers }) {
      main.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <h2>Purchase Bills</h2>
          <button class="btn primary" onclick="render('new_purchase')">New Bill</button>
        </div>
        <div class="card">
          <div style="overflow-x:auto;">
          <table>
            <thead><tr><th>Date</th><th>Bill #</th><th>Supplier</th><th class="right">Total</th><th class="right">Due</th><th>Actions</th></tr></thead>
            <tbody>${purchases.map(p => {
                const sup = suppliers.find(s => s.id === p.supplierId)?.name || 'N/A';
                const due = (p.total || 0) - (p.paid || 0);
                return `<tr style="cursor:pointer;" onclick="render('view_purchase', '${p.id}')"><td>${p.date}</td><td>${p.bill}</td><td>${sup}</td><td class="right">₹ ${fmt(p.total)}</td><td class="right" style="color:${due > 0.01 ? '#ef4444' : 'inherit'}">₹ ${fmt(due)}</td><td onclick="event.stopPropagation()"><button class="btn ghost small" onclick="render('new_purchase', '${p.id}')">Edit</button></td></tr>`
            }).join('')}</tbody>
          </table>
          </div>
        </div>`;
    }
    
    function renderPurchaseForm({ products, suppliers }, purchaseId) {
        const allPurchases = load('purchases');
        let p = purchaseId ? allPurchases.find(p => p.id === purchaseId) : null;
        const originalPurchase = p ? JSON.parse(JSON.stringify(p)) : null;
        if (!p) p = { id: '', date: today(), bill: `BILL-${Date.now()}`, supplierId: '', items: [], total: 0, paid: 0 };

        main.innerHTML = `
            <h2>${purchaseId ? 'Edit' : 'New'} Purchase Bill</h2>
            <div class="card">
                <form id="purchase-form">
                    <div class="row">
                        <div style="flex:1"><label>Supplier</label><select name="supplierId" required>${suppliers.map(s => `<option value="${s.id}" ${s.id === p.supplierId ? 'selected' : ''}>${s.name}</option>`).join('')}</select></div>
                        <div style="flex:1"><label>Bill #</label><input name="bill" value="${p.bill}" required></div>
                        <div style="flex:1"><label>Date</label><input name="date" type="date" value="${p.date}" required></div>
                    </div>
                </form>
            </div>
            <div class="card">
                <h3>Add Products</h3>
                <div class="row">
                    <div style="flex:3"><label>Product</label><select id="item-product">${products.map(p => `<option value="${p.id}" data-cost="${p.cost}">${p.name}</option>`).join('')}</select></div>
                    <div style="flex:1"><label>Quantity</label><input id="item-qty" type="number" value="1"></div>
                    <div style="flex:1"><label>Cost (₹)</label><input id="item-cost" type="number" step="0.01"></div>
                    <div style="margin-top:21px;"><button type="button" class="btn primary" id="add-item-btn">Add</button></div>
                </div>
                <div style="overflow-x:auto;">
                <table id="purchase-items-table"><thead><tr><th>Product</th><th class="right">Qty</th><th class="right">Cost</th><th class="right">Amount</th><th></th></tr></thead><tbody></tbody></table>
                </div>
            </div>
            <div class="card row" style="justify-content: flex-end;">
                 <div style="width:250px;">
                    <div class="row bold" style="justify-content:space-between;font-size:18px;"><span>Total:</span> <span id="total">₹ 0.00</span></div>
                    <div class="row" style="margin-top:8px;"><label>Amount Paid</label><input id="amount-paid" type="number" step="0.01" value="${p.paid || 0}"></div>
                </div>
            </div>
            <div class="row" style="justify-content:flex-end; gap:8px;"><button class="btn ghost" onclick="render('purchases')">Cancel</button><button class="btn primary" id="save-purchase-btn">Save Bill</button></div>
        `;

        let items = [...(p.items || [])];
        const productSel = document.getElementById('item-product');
        const costInput = document.getElementById('item-cost');
        const updateCost = () => costInput.value = productSel.options[productSel.selectedIndex].dataset.cost;
        productSel.onchange = updateCost; updateCost();

        const renderItems = () => {
            const tbody = document.getElementById('purchase-items-table').querySelector('tbody');
            let total = 0;
            tbody.innerHTML = items.map((item, index) => {
                const prod = products.find(pr => pr.id === item.productId);
                const amount = item.qty * item.cost;
                total += amount;
                return `<tr><td>${prod?prod.name:'N/A'}</td><td class="right">${item.qty}</td><td class="right">₹ ${fmt(item.cost)}</td><td class="right">₹ ${fmt(amount)}</td><td class="center"><button type="button" class="btn danger small" onclick="window.removePurchaseItem(${index})">X</button></td></tr>`;
            }).join('');
            document.getElementById('total').textContent = `₹ ${fmt(total)}`;
        };

        window.removePurchaseItem = (index) => { items.splice(index, 1); renderItems(); };
        document.getElementById('add-item-btn').onclick = () => {
            const productId = productSel.value;
            const qty = Number(document.getElementById('item-qty').value);
            const cost = Number(document.getElementById('item-cost').value);
            if (!productId || qty <= 0 || cost < 0) return showToast('Invalid item details');
            items.push({ productId, qty, cost });
            renderItems();
        };
        
        document.getElementById('save-purchase-btn').onclick = () => {
            const prods = load('products');
            const formData = new FormData(document.getElementById('purchase-form'));
            const newPurchase = {
                id: p.id || uid('pr'),
                supplierId: formData.get('supplierId'), bill: formData.get('bill'), date: formData.get('date'),
                items,
                total: items.reduce((acc, i) => acc + i.qty * i.cost, 0),
                paid: Number(document.getElementById('amount-paid').value)
            };

            // --- CRITICAL: Stock Update Logic for Purchases ---
            if (originalPurchase) {
                originalPurchase.items.forEach(item => {
                    const pIndex = prods.findIndex(p => p.id === item.productId);
                    if (pIndex > -1) prods[pIndex].stock = (prods[pIndex].stock || 0) - item.qty;
                });
            }
            newPurchase.items.forEach(item => {
                const pIndex = prods.findIndex(p => p.id === item.productId);
                if (pIndex > -1) prods[pIndex].stock = Number(prods[pIndex].stock || 0) + item.qty;
            });
            save('products', prods);
            
            save('purchases', p.id ? allPurchases.map(pu => pu.id === p.id ? newPurchase : pu) : [newPurchase, ...allPurchases]);
            showToast('Purchase saved!');
            render('view_purchase', newPurchase.id);
        };
        renderItems();
    }

    // ========== RENDER: INVOICE/BILL VIEW & PDF EXPORT ==========
    function renderSaleView({ sales, customers, products }, saleId) {
        const sale = sales.find(s => s.id === saleId);
        if (!sale) { main.innerHTML = '<h2>Invoice not found</h2>'; return; }
        const customer = customers.find(c => c.id === sale.customerId) || {};
        const due = (sale.total || 0) - (sale.paid || 0);

        main.innerHTML = `
            <div class="invoice-actions">
                <button class="btn ghost" onclick="render('sales')">Back to Sales</button>
                <button class="btn ghost" onclick="render('new_sale', '${saleId}')">Edit</button>
                <button class="btn primary" onclick="printInvoice('${saleId}')">Print / Save PDF</button>
            </div>
            <div id="invoice-content" class="invoice-view">
                <div class="invoice-header">
                    <div>
                        <h3>From:</h3>
                        <p><strong>${getSetting('companyName') || 'Your Company'}</strong><br>
                        ${getSetting('companyAddress')?.replace(/\n/g, '<br>') || 'Your Address'}</p>
                    </div>
                    <div>
                        <h3>To:</h3>
                        <p><strong>${customer.name || 'N/A'}</strong><br>
                        ${customer.phone || ''}<br>${customer.email || ''}</p>
                    </div>
                    <div>
                        <h3>Invoice Details</h3>
                        <p><strong>Invoice #:</strong> ${sale.invoice}<br>
                        <strong>Date:</strong> ${sale.date}</p>
                    </div>
                </div>
                <div style="overflow-x:auto;">
                <table>
                    <thead><tr><th>Item</th><th class="right">Qty</th><th class="right">Price</th><th class="right">Total</th></tr></thead>
                    <tbody>
                        ${sale.items.map(item => {
                            const p = products.find(pr => pr.id === item.productId);
                            return `<tr>
                                <td>${p ? p.name : 'N/A'}</td>
                                <td class="right">${item.qty}</td>
                                <td class="right">₹ ${fmt(item.price)}</td>
                                <td class="right">₹ ${fmt(item.qty * item.price)}</td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                    <tfoot>
                        <tr><td colspan="3" class="right bold">Total</td><td class="right bold">₹ ${fmt(sale.total)}</td></tr>
                        <tr><td colspan="3" class="right">Paid</td><td class="right">₹ ${fmt(sale.paid)}</td></tr>
                        <tr><td colspan="3" class="right bold">Amount Due</td><td class="right bold">₹ ${fmt(due)}</td></tr>
                    </tfoot>
                </table>
                </div>
            </div>`;
    }

    function renderPurchaseView({ purchases, suppliers, products }, purchaseId) {
        const purchase = purchases.find(p => p.id === purchaseId);
        if (!purchase) { main.innerHTML = '<h2>Bill not found</h2>'; return; }
        const supplier = suppliers.find(s => s.id === purchase.supplierId) || {};
        const due = (purchase.total || 0) - (purchase.paid || 0);

        main.innerHTML = `
            <div class="invoice-actions">
                <button class="btn ghost" onclick="render('purchases')">Back to Purchases</button>
                <button class="btn ghost" onclick="render('new_purchase', '${purchaseId}')">Edit</button>
            </div>
            <div id="bill-content" class="invoice-view">
                 <div class="invoice-header">
                    <div>
                        <h3>From (Supplier):</h3>
                        <p><strong>${supplier.name || 'N/A'}</strong><br>
                        ${supplier.phone || ''}<br>${supplier.email || ''}</p>
                    </div>
                    <div>
                        <h3>To (Billed To):</h3>
                        <p><strong>${getSetting('companyName') || 'Your Company'}</strong><br>
                        ${getSetting('companyAddress')?.replace(/\n/g, '<br>') || 'Your Address'}</p>
                    </div>
                    <div>
                        <h3>Bill Details</h3>
                        <p><strong>Bill #:</strong> ${purchase.bill}<br>
                        <strong>Date:</strong> ${purchase.date}</p>
                    </div>
                </div>
                <div style="overflow-x:auto;">
                <table>
                    <thead><tr><th>Item</th><th class="right">Qty</th><th class="right">Cost</th><th class="right">Total</th></tr></thead>
                    <tbody>
                        ${purchase.items.map(item => {
                            const p = products.find(pr => pr.id === item.productId);
                            return `<tr>
                                <td>${p ? p.name : 'N/A'}</td>
                                <td class="right">${item.qty}</td>
                                <td class="right">₹ ${fmt(item.cost)}</td>
                                <td class="right">₹ ${fmt(item.qty * item.cost)}</td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                    <tfoot>
                        <tr><td colspan="3" class="right bold">Total</td><td class="right bold">₹ ${fmt(purchase.total)}</td></tr>
                        <tr><td colspan="3" class="right">Paid</td><td class="right">₹ ${fmt(purchase.paid)}</td></tr>
                        <tr><td colspan="3" class="right bold">Amount Due</td><td class="right bold">₹ ${fmt(due)}</td></tr>
                    </tfoot>
                </table>
                </div>
            </div>
        `;
    }

    window.printInvoice = (saleId) => {
        const invoiceElement = document.getElementById('invoice-content');
        const sale = load('sales').find(s => s.id === saleId);
        if (!invoiceElement || !sale) return;

        showToast('Generating PDF...');
        html2canvas(invoiceElement).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            pdf.save(`Invoice-${sale.invoice}.pdf`);
        });
    };
    
    // ========== RENDER: PAYMENTS & RECEIPTS ==========
    function renderPayments({ payments, sales, purchases, customers, suppliers }) {
      main.innerHTML = `
        <h2>Payments & Receipts</h2>
        <div class="card">
          <div class="row">
            <div style="flex:1"><label>Type</label><select id="pt-type"><option value="receipt">Receipt (from Customer)</option><option value="payment">Payment (to Supplier)</option></select></div>
            <div style="flex:2"><label>Reference (Invoice/Bill)</label><select id="pt-ref"></select></div>
            <div style="flex:1"><label>Date</label><input id="pt-date" type="date" value="${today()}"/></div>
          </div>
          <div class="row" style="margin-top:8px; align-items:flex-end;">
            <div style="flex:1"><label>Amount (₹)</label><input id="pt-amt" type="number" step="0.01"/></div>
            <div style="flex:1"><label>Method</label><input id="pt-method" placeholder="Cash/Bank/UPI"/></div>
            <div><button id="pt-save" class="btn primary">Record Payment</button></div>
          </div>
        </div>
        <div class="card">
          <h3>All Transactions</h3>
          <div style="overflow-x:auto;">
          <table>
            <thead><tr><th>Date</th><th>Type</th><th>Reference</th><th class="right">Amount</th><th>Method</th></tr></thead>
            <tbody>${payments.map(pm => {
                let refLabel = '–';
                if (pm.refType === 'sale') {
                    const inv = sales.find(s => s.id === pm.refId);
                    const cust = customers.find(c => c.id === inv?.customerId);
                    refLabel = inv ? `INV ${inv.invoice} (${cust?.name})` : 'Sale';
                } else if (pm.refType === 'purchase') {
                    const bill = purchases.find(b => b.id === pm.refId);
                    const sup = suppliers.find(s => s.id === bill?.supplierId);
                    refLabel = bill ? `BILL ${bill.bill} (${sup?.name})` : 'Purchase';
                }
                return `<tr><td>${pm.date}</td><td>${pm.type}</td><td>${refLabel}</td><td class="right">₹ ${fmt(pm.amount)}</td><td>${pm.method}</td></tr>`;
            }).join('')}</tbody>
          </table>
          </div>
        </div>`;
    
      const refSel = document.getElementById('pt-ref');
      const populateRefs = () => {
        refSel.innerHTML = '';
        const type = document.getElementById('pt-type').value;
        const options = type === 'receipt' ?
            sales.map(inv => ({ inv, due: (inv.total || 0) - (inv.paid || 0), cust: customers.find(c => c.id === inv.customerId) }))
                 .filter(x => x.due > 0.01)
                 .map(x => `<option value="sale:${x.inv.id}">INV ${x.inv.invoice} - ${x.cust?.name} (Due ₹ ${fmt(x.due)})</option>`) :
            purchases.map(bill => ({ bill, due: (bill.total || 0) - (bill.paid || 0), sup: suppliers.find(s => s.id === bill.supplierId) }))
                 .filter(x => x.due > 0.01)
                 .map(x => `<option value="purchase:${x.bill.id}">BILL ${x.bill.bill} - ${x.sup?.name} (Due ₹ ${fmt(x.due)})</option>`);
        refSel.innerHTML = options.join('') || '<option value="">No outstanding references</option>';
      };
    
      document.getElementById('pt-type').onchange = populateRefs;
      populateRefs();
    
      document.getElementById('pt-save').onclick = () => {
        const ref = document.getElementById('pt-ref').value;
        if (!ref) return showToast('Select a reference');
        const [rType, id] = ref.split(':');
        const amount = Number(document.getElementById('pt-amt').value || 0);
        if (amount <= 0) return showToast('Enter a valid amount');
    
        const payment = { id: uid('pay'), type: rType === 'sale' ? 'receipt' : 'payment', refType: rType, refId: id, date: document.getElementById('pt-date').value, amount, method: document.getElementById('pt-method').value || 'Cash' };
        save('payments', [payment, ...load('payments')]);
    
        const arrKey = rType === 'sale' ? 'sales' : 'purchases';
        const arr = load(arrKey);
        const item = arr.find(x => x.id === id);
        if (item) item.paid = (Number(item.paid) || 0) + amount;
        save(arrKey, arr);
    
        showToast('Payment recorded');
        render('payments');
      };
    }
    
    // ========== RENDER: REPORTS & EXPORT ==========
    function renderReports({ sales, customers }) {
        main.innerHTML = `
            <h2>Reports & Data Management</h2>
            <div class="card">
                <h3>Sales Report</h3>
                <div class="row">
                    <div style="flex:1"><label>Start Date</label><input type="date" id="start-date" value="${new Date(new Date().setMonth(new Date().getMonth() - 1)).toISOString().slice(0,10)}"></div>
                    <div style="flex:1"><label>End Date</label><input type="date" id="end-date" value="${today()}"></div>
                    <div style="align-self:flex-end;"><button class="btn primary" id="run-report">Run Report</button></div>
                </div>
                <div id="report-output" style="margin-top:16px;"></div>
            </div>
            <div class="card">
                <h3>Export Data</h3>
                <p class="small">Download all your data (products, sales, etc.) into a single JSON file for backup.</p>
                <button class="btn primary" id="export-btn">Export All Data</button>
            </div>
            <div class="card">
                <h3>Import Data</h3>
                <p class="small">Import data from a previously exported JSON file. <b style="color:#ef4444">Warning: This will overwrite all current data.</b></p>
                <input type="file" id="import-file" accept=".json">
                <button class="btn danger" id="import-btn" style="margin-top:8px;">Import and Overwrite</button>
            </div>`;
    
        document.getElementById('run-report').onclick = () => {
            const start = document.getElementById('start-date').value;
            const end = document.getElementById('end-date').value;
            const filteredSales = sales.filter(s => s.date >= start && s.date <= end);
            
            let total = 0, paid = 0;
            let reportHTML = `<div style="overflow-x:auto;"><table><thead><tr><th>Date</th><th>Invoice</th><th>Customer</th><th class="right">Total</th><th class="right">Paid</th><th class="right">Due</th></tr></thead><tbody>`;
            filteredSales.forEach(s => {
                const cust = customers.find(c => c.id === s.customerId)?.name || 'N/A';
                const due = (s.total || 0) - (s.paid || 0);
                total += s.total || 0;
                paid += s.paid || 0;
                reportHTML += `<tr><td>${s.date}</td><td>${s.invoice}</td><td>${cust}</td><td class="right">₹ ${fmt(s.total)}</td><td class="right">₹ ${fmt(s.paid)}</td><td class="right">₹ ${fmt(due)}</td></tr>`;
            });
            reportHTML += `</tbody><tfoot><tr class="bold"><td>Totals</td><td></td><td></td><td class="right">₹ ${fmt(total)}</td><td class="right">₹ ${fmt(paid)}</td><td class="right">₹ ${fmt(total - paid)}</td></tr></tfoot></table></div>`;
            document.getElementById('report-output').innerHTML = reportHTML;
        };

        document.getElementById('export-btn').onclick = () => {
            const data = LS_KEYS.reduce((acc, k) => ({ ...acc, [k]: load(k) }), {});
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data exported!');
        };
    
        document.getElementById('import-btn').onclick = () => {
            const fileInput = document.getElementById('import-file');
            if (fileInput.files.length === 0) return showToast('Please select a file to import.');
            if (!confirm('ARE YOU SURE?\nThis will permanently delete all current data and replace it with the data from the file.')) return;
    
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    let imported = 0;
                    for (const key of LS_KEYS) {
                        if (data[key]) {
                            save(key, data[key]);
                            imported++;
                        }
                    }
                    if (imported > 0) {
                        showToast('Data successfully imported! The app will now reload.');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showToast('Import failed: Invalid file format.');
                    }
                } catch (err) {
                    showToast('Import failed: Could not parse the file.');
                }
            };
            reader.readAsText(fileInput.files[0]);
        };
    }

    // ========== RENDER: SETTINGS ==========
    function renderSettings() {
        const details = load('companyDetails');
        main.innerHTML = `
            <h2>Settings</h2>
            <div class="card">
                <h3>Company Details</h3>
                <p class="small">This information will appear on your invoices.</p>
                <form id="settings-form">
                    <div class="row">
                        <div style="flex:1;"><label>Company Name</label><input name="companyName" value="${details.companyName || ''}"></div>
                    </div>
                    <div class="row">
                        <div style="flex:1;"><label>Address</label><textarea name="companyAddress" rows="4">${details.companyAddress || ''}</textarea></div>
                    </div>
                    <div class="row" style="justify-content:flex-end; margin-top:16px;">
                      <button type="submit" class="btn primary">Save Settings</button>
                    </div>
                </form>
            </div>
        `;

        document.getElementById('settings-form').onsubmit = e => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newDetails = Object.fromEntries(formData.entries());
            save('companyDetails', newDetails);
            showToast('Settings saved!');
            render('settings');
        };
    }

    // ========== APP INITIALIZATION ==========
    (function init() {
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
        }
        initIfEmpty();
        render('dashboard');
    })();
  </script>
</body>
</html>
