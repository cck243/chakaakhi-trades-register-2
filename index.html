<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sales & Purchase — Full App (Single File)</title>
<style>
  :root{--accent:#2b7a78;--muted:#6b7280}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:#f3f4f6;color:#111}
  header{background:var(--accent);color:#fff;padding:12px 18px;display:flex;align-items:center;justify-content:space-between}
  header h1{font-size:18px;margin:0}
  .wrap{display:flex;gap:16px;padding:16px;align-items:flex-start}
  nav{width:260px;background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(15,23,42,.06)}
  nav button{display:flex;gap:8px;align-items:center;width:100%;padding:10px;border-radius:8px;border:0;background:transparent;cursor:pointer;color:#0f172a;margin-bottom:8px}
  nav button.active{background:linear-gradient(90deg, rgba(43,122,120,.08), rgba(43,122,120,.03));font-weight:600}
  main{flex:1;background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(15,23,42,.04)}
  h2{margin:0 0 12px 0;font-size:20px}
  .row{display:flex;gap:8px}
  input,select,textarea,button{font-size:14px}
  input,select,textarea{padding:8px;border-radius:6px;border:1px solid #e5e7eb;box-sizing:border-box}
  button.btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
  button.primary{background:var(--accent);color:#fff}
  button.ghost{background:#fff;border:1px solid #e5e7eb}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px;border-bottom:1px solid #f3f4f6;text-align:left;font-size:13px}
  .right{text-align:right}
  .small{font-size:12px;color:var(--muted)}
  .badge{padding:6px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:13px}
  .card{background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 6px rgba(2,6,23,.03);margin-bottom:12px}
  .modal-back{position:fixed;inset:0;background:rgba(2,6,23,.5);display:flex;align-items:center;justify-content:center;z-index:60}
  .modal{width:900px;max-width:95%;background:#fff;padding:16px;border-radius:10px;max-height:85vh;overflow:auto}
  .muted{color:var(--muted)}
  footer{padding:12px;text-align:center;color:var(--muted)}
  @media(max-width:880px){ .wrap{flex-direction:column} nav{width:100%} }
</style>
</head>
<body>
<header>
  <h1>Sales & Purchase Management — Single-file</h1>
  <div class="small">Local demo — data stored in browser localStorage</div>
</header>

<div class="wrap">
  <nav id="nav">
    <button data-tab="dashboard" class="active">Dashboard</button>
    <button data-tab="products">Products / Stock</button>
    <button data-tab="customers">Customers</button>
    <button data-tab="suppliers">Suppliers</button>
    <button data-tab="sales">Sales (Invoices)</button>
    <button data-tab="purchases">Purchases (Bills)</button>
    <button data-tab="payments">Payments & Receipts</button>
    <button data-tab="reports">Reports / Export</button>
  </nav>

  <main id="main">
    <!-- Content will be rendered here -->
  </main>
</div>

<footer>Save file and open in browser. You can Export/Import JSON under Reports.</footer>

<!-- Modal placeholder -->
<div id="modal-root"></div>

<script>
/* -------------------------
  Simple full-feature app (no backend)
  - data saved in localStorage keys:
    products, customers, suppliers, sales, purchases, payments
  - supports: CRUD, stock update, payments linking, export/import, print
------------------------- */

const LS_KEYS = ['products','customers','suppliers','sales','purchases','payments'];
const uid = (p='id') => p + Date.now().toString(36) + Math.random().toString(36).slice(2,6);
const fmt = n => Number(n||0).toLocaleString('en-IN',{maximumFractionDigits:2});
const today = () => new Date().toISOString().slice(0,10);

function load(key){ try { return JSON.parse(localStorage.getItem(key) || '[]') } catch(e){ return [] } }
function save(key, arr){ localStorage.setItem(key, JSON.stringify(arr || [])) }
function initIfEmpty(){
  if(!localStorage.getItem('products')) save('products', [
    {id:uid('p'), sku:'P-001', name:'Widget A', category:'General', price:100, cost:70, stock:50, unit:'pcs', minStock:5},
    {id:uid('p'), sku:'P-002', name:'Widget B', category:'General', price:200, cost:140, stock:30, unit:'pcs', minStock:5}
  ]);
  if(!localStorage.getItem('customers')) save('customers', [{id:uid('c'), name:'Walk-in Customer', phone:'', email:''}]);
  if(!localStorage.getItem('suppliers')) save('suppliers', []);
  if(!localStorage.getItem('sales')) save('sales', []);
  if(!localStorage.getItem('purchases')) save('purchases', []);
  if(!localStorage.getItem('payments')) save('payments', []);
}
initIfEmpty();

/* NAV & RENDERING */
const nav = document.getElementById('nav');
const main = document.getElementById('main');
const modalRoot = document.getElementById('modal-root');

nav.addEventListener('click', (e) => {
  if(e.target.dataset.tab){
    document.querySelectorAll('#nav button').forEach(b=>b.classList.remove('active'));
    e.target.classList.add('active');
    render(e.target.dataset.tab);
  }
});

function render(tab='dashboard'){
  const data = {
    products: load('products'),
    customers: load('customers'),
    suppliers: load('suppliers'),
    sales: load('sales'),
    purchases: load('purchases'),
    payments: load('payments')
  };
  if(tab==='dashboard') renderDashboard(data);
  if(tab==='products') renderProducts(data);
  if(tab==='customers') renderCustomers(data);
  if(tab==='suppliers') renderSuppliers(data);
  if(tab==='sales') renderSales(data);
  if(tab==='purchases') renderPurchases(data);
  if(tab==='payments') renderPayments(data);
  if(tab==='reports') renderReports(data);
}

/* ---------- DASHBOARD ---------- */
function renderDashboard({products,sales,purchases,payments}){
  const totalSales = sales.reduce((s,x)=>s+Number(x.total||0),0);
  const totalPurchases = purchases.reduce((s,x)=>s+Number(x.total||0),0);
  const receipts = payments.filter(p=>p.type==='receipt').reduce((s,x)=>s+Number(x.amount||0),0);
  const outPayments = payments.filter(p=>p.type==='payment').reduce((s,x)=>s+Number(x.amount||0),0);
  const receivables = sales.reduce((s,x)=>s + (Number(x.due||0)),0);
  const payables = purchases.reduce((s,x)=>s + (Number(x.due||0)),0);
  const lowStock = products.filter(p => Number(p.stock||0) <= Number(p.minStock||0));
  main.innerHTML = `
    <h2>Dashboard</h2>
    <div class="card row" style="gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:220px;padding:12px;border-radius:8px;background:linear-gradient(90deg,#eef8f7,#ffffff)"><div class="small">Total Sales</div><div style="font-size:20px;font-weight:700">₹ ${fmt(totalSales)}</div></div>
      <div style="flex:1;min-width:220px;padding:12px;border-radius:8px;background:linear-gradient(90deg,#f0fdf4,#ffffff)"><div class="small">Total Purchases</div><div style="font-size:20px;font-weight:700">₹ ${fmt(totalPurchases)}</div></div>
      <div style="flex:1;min-width:220px;padding:12px;border-radius:8px;background:linear-gradient(90deg,#fff7ed,#ffffff)"><div class="small">Receivables (Due)</div><div style="font-size:20px;font-weight:700">₹ ${fmt(receivables)}</div></div>
      <div style="flex:1;min-width:220px;padding:12px;border-radius:8px;background:linear-gradient(90deg,#fff1f2,#ffffff)"><div class="small">Payables (Due)</div><div style="font-size:20px;font-weight:700">₹ ${fmt(payables)}</div></div>
    </div>
    <div class="card" style="margin-top:12px">
      <h3 style="margin-top:0">Low Stock Alerts</h3>
      ${ lowStock.length ? `<table><thead><tr><th>SKU</th><th>Product</th><th>Stock</th><th>Min</th></tr></thead><tbody>${lowStock.map(p=>`<tr><td>${p.sku||''}</td><td>${p.name}</td><td class="right">${p.stock} ${p.unit||''}</td><td class="right">${p.minStock||0}</td></tr>`).join('')}</tbody></table>` : '<div class="small">No low-stock products</div>'}
    </div>
  `;
}

/* ---------- PRODUCTS ---------- */
function renderProducts({products}){
  main.innerHTML = `
    <h2>Products / Stock</h2>
    <div class="card">
      <div class="row" style="align-items:end">
        <div style="flex:2"><label>Product name</label><input id="p-name" /></div>
        <div style="flex:1"><label>SKU</label><input id="p-sku" /></div>
        <div style="flex:1"><label>Category</label><input id="p-cat" /></div>
      </div>
      <div class="row" style="align-items:end;margin-top:8px">
        <div style="flex:1"><label>Price</label><input id="p-price" type="number" /></div>
        <div style="flex:1"><label>Cost</label><input id="p-cost" type="number" /></div>
        <div style="flex:1"><label>Stock</label><input id="p-stock" type="number" value="0" /></div>
        <div style="flex:1"><label>Unit</label><input id="p-unit" placeholder='pcs/kg' /></div>
        <div style="display:flex;align-items:center"><button id="p-add" class="btn primary">Add Product</button></div>
      </div>
    </div>
    <div class="card">
      <h3 style="margin-top:0">Product List</h3>
      <table><thead><tr><th>SKU</th><th>Name</th><th>Category</th><th class="right">Price</th><th class="right">Cost</th><th class="right">Stock</th><th></th></tr></thead><tbody id="prod-tbody"></tbody></table>
    </div>
  `;
  const tbody = document.getElementById('prod-tbody');
  function refresh(){
    const prods = load('products');
    tbody.innerHTML = prods.map(p=>`<tr>
      <td>${p.sku||''}</td>
      <td>${p.name}</td>
      <td>${p.category||''}</td>
      <td class="right">₹ ${fmt(p.price)}</td>
      <td class="right">₹ ${fmt(p.cost)}</td>
      <td class="right">${p.stock} ${p.unit||''}</td>
      <td class="right"><button data-id="${p.id}" class="edit btn ghost">Edit</button> <button data-id="${p.id}" class="adj btn ghost">Adj</button> <button data-id="${p.id}" class="del btn ghost">Delete</button></td>
    </tr>`).join('');
    // attach handlers
    tbody.querySelectorAll('.edit').forEach(b=>b.onclick=()=>{ const id=b.dataset.id; editProduct(id); });
    tbody.querySelectorAll('.del').forEach(b=>b.onclick=()=>{ if(confirm('Delete product?')){ const arr=load('products').filter(x=>x.id!==b.dataset.id); save('products',arr); refresh(); } });
    tbody.querySelectorAll('.adj').forEach(b=>b.onclick=()=>{ const id=b.dataset.id; const delta = Number(prompt('Enter stock change (positive to add, negative to reduce)','0')||0); if(delta!==0){ const arr = load('products'); const p = arr.find(x=>x.id===id); if(p){ p.stock = Number(p.stock||0) + delta; save('products',arr); refresh(); } } });
  }
  document.getElementById('p-add').onclick = ()=>{
    const name=document.getElementById('p-name').value.trim(); if(!name){ alert('Enter product name'); return; }
    const p = { id: uid('p'), sku: document.getElementById('p-sku').value.trim(), name, category: document.getElementById('p-cat').value.trim(), price: Number(document.getElementById('p-price').value||0), cost: Number(document.getElementById('p-cost').value||0), stock: Number(document.getElementById('p-stock').value||0), unit: document.getElementById('p-unit').value||'pcs', minStock:0 };
    const arr = load('products'); arr.push(p); save('products',arr);
    document.getElementById('p-name').value=''; document.getElementById('p-sku').value=''; document.getElementById('p-price').value=''; document.getElementById('p-cost').value=''; document.getElementById('p-stock').value='0'; render('products');
  };
  function editProduct(id){
    const p = load('products').find(x=>x.id===id);
    if(!p) return;
    const newName = prompt('Name',p.name); if(newName===null) return;
    p.name = newName; p.sku = prompt('SKU',p.sku)||p.sku; p.category = prompt('Category',p.category)||p.category; p.price = Number(prompt('Price',p.price)||p.price); p.cost = Number(prompt('Cost',p.cost)||p.cost); p.unit = prompt('Unit',p.unit)||p.unit; p.minStock = Number(prompt('Min stock',p.minStock||0)||p.minStock);
    const arr = load('products').map(x=> x.id===id? p : x); save('products',arr); render('products');
  }
  refresh();
}

/* ---------- CUSTOMERS ---------- */
function renderCustomers({customers}){
  main.innerHTML = `
    <h2>Customers</h2>
    <div class="card">
      <div class="row" style="align-items:end">
        <div style="flex:2"><label>Name</label><input id="c-name" /></div>
        <div style="flex:1"><label>Phone</label><input id="c-phone" /></div>
        <div style="flex:1"><label>Email</label><input id="c-email" /></div>
      </div>
      <div style="margin-top:8px" class="row">
        <div style="flex:2"><label>GST</label><input id="c-gst" /></div>
        <div style="flex:3"><label>Address</label><input id="c-address" /></div>
        <div style="display:flex;align-items:center"><button id="c-add" class="btn primary">Add Customer</button></div>
      </div>
    </div>
    <div class="card">
      <h3 style="margin-top:0">Customer List</h3>
      <table><thead><tr><th>Name</th><th>Phone</th><th>Email</th><th>GST</th><th></th></tr></thead><tbody id="cust-tbody"></tbody></table>
    </div>
  `;
  const tbody = document.getElementById('cust-tbody');
  function refresh(){
    const arr = load('customers');
    tbody.innerHTML = arr.map(c=>`<tr><td>${c.name}</td><td>${c.phone||''}</td><td>${c.email||''}</td><td>${c.gst||''}</td><td class="right"><button data-id="${c.id}" class="edit btn ghost">Edit</button> <button data-id="${c.id}" class="del btn ghost">Delete</button></td></tr>`).join('');
    tbody.querySelectorAll('.edit').forEach(b=>b.onclick=()=>{ const id=b.dataset.id; editCustomer(id); });
    tbody.querySelectorAll('.del').forEach(b=>b.onclick=()=>{ if(confirm('Delete customer?')){ const arr=load('customers').filter(x=>x.id!==b.dataset.id); save('customers',arr); refresh(); } });
  }
  document.getElementById('c-add').onclick = ()=>{
    const name=document.getElementById('c-name').value.trim(); if(!name){ alert('Enter name'); return; }
    const c = { id: uid('c'), name, phone: document.getElementById('c-phone').value.trim(), email: document.getElementById('c-email').value.trim(), gst: document.getElementById('c-gst').value.trim(), address: document.getElementById('c-address').value.trim() };
    const arr = load('customers'); arr.push(c); save('customers',arr); render('customers');
  };
  function editCustomer(id){
    const c = load('customers').find(x=>x.id===id);
    if(!c) return;
    c.name = prompt('Name',c.name)||c.name; c.phone = prompt('Phone',c.phone)||c.phone; c.email = prompt('Email',c.email)||c.email; c.gst = prompt('GST',c.gst)||c.gst; c.address = prompt('Address',c.address)||c.address;
    const arr = load('customers').map(x=> x.id===id? c : x); save('customers',arr); render('customers');
  }
  refresh();
}

/* ---------- SUPPLIERS ---------- */
function renderSuppliers({suppliers}){
  main.innerHTML = `
    <h2>Suppliers</h2>
    <div class="card">
      <div class="row" style="align-items:end">
        <div style="flex:2"><label>Name</label><input id="s-name" /></div>
        <div style="flex:1"><label>Phone</label><input id="s-phone" /></div>
        <div style="flex:1"><label>Email</label><input id="s-email" /></div>
      </div>
      <div style="margin-top:8px" class="row">
        <div style="flex:2"><label>GST</label><input id="s-gst" /></div>
        <div style="flex:3"><label>Address</label><input id="s-address" /></div>
        <div style="display:flex;align-items:center"><button id="s-add" class="btn primary">Add Supplier</button></div>
      </div>
    </div>
    <div class="card">
      <h3 style="margin-top:0">Supplier List</h3>
      <table><thead><tr><th>Name</th><th>Phone</th><th>Email</th><th>GST</th><th></th></tr></thead><tbody id="sup-tbody"></tbody></table>
    </div>
  `;
  const tbody = document.getElementById('sup-tbody');
  function refresh(){
    const arr = load('suppliers');
    tbody.innerHTML = arr.map(s=>`<tr><td>${s.name}</td><td>${s.phone||''}</td><td>${s.email||''}</td><td>${s.gst||''}</td><td class="right"><button data-id="${s.id}" class="edit btn ghost">Edit</button> <button data-id="${s.id}" class="del btn ghost">Delete</button></td></tr>`).join('');
    tbody.querySelectorAll('.edit').forEach(b=>b.onclick=()=>{ const id=b.dataset.id; editSupplier(id); });
    tbody.querySelectorAll('.del').forEach(b=>b.onclick=()=>{ if(confirm('Delete supplier?')){ const arr=load('suppliers').filter(x=>x.id!==b.dataset.id); save('suppliers',arr); refresh(); } });
  }
  document.getElementById('s-add').onclick = ()=>{
    const name=document.getElementById('s-name').value.trim(); if(!name){ alert('Enter name'); return; }
    const s = { id: uid('sup'), name, phone: document.getElementById('s-phone').value.trim(), email: document.getElementById('s-email').value.trim(), gst: document.getElementById('s-gst').value.trim(), address: document.getElementById('s-address').value.trim() };
    const arr = load('suppliers'); arr.push(s); save('suppliers',arr); render('suppliers');
  };
  function editSupplier(id){
    const c = load('suppliers').find(x=>x.id===id);
    if(!c) return;
    c.name = prompt('Name',c.name)||c.name; c.phone = prompt('Phone',c.phone)||c.phone; c.email = prompt('Email',c.email)||c.email; c.gst = prompt('GST',c.gst)||c.gst; c.address = prompt('Address',c.address)||c.address;
    const arr = load('suppliers').map(x=> x.id===id? c : x); save('suppliers',arr); render('suppliers');
  }
  refresh();
}

/* ---------- SALES (Invoices) ---------- */
function renderSales({products,customers,sales}){
  main.innerHTML = `
    <h2>Sales / Invoices</h2>
    <div class="card">
      <div class="row">
        <div style="flex:2"><label>Customer</label><select id="sale-cust">${customers.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}</select></div>
        <div style="flex:1"><label>Date</label><input id="sale-date" type="date" value="${today()}" /></div>
        <div style="flex:1"><label>Invoice #</label><input id="sale-inv" value="INV-${Date.now().toString().slice(-6)}" /></div>
      </div>
      <div style="margin-top:8px"><div id="sale-lines"></div><button id="sale-add-line" class="btn ghost" style="margin-top:8px">Add Line</button></div>
      <div class="row" style="margin-top:8px;align-items:center">
        <div style="flex:2"><label>Notes</label><input id="sale-notes" /></div>
        <div style="flex:1"><label>Discount</label><input id="sale-disc" type="number" value="0" /></div>
        <div style="flex:1" class="right"><label>Total</label><div id="sale-total" class="badge">0</div></div>
      </div>
      <div style="margin-top:8px"><button id="save-sale" class="btn primary">Save Invoice</button></div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Invoices</h3>
      <table><thead><tr><th>#</th><th>Customer</th><th>Date</th><th class="right">Total</th><th class="right">Paid</th><th>Status</th><th></th></tr></thead><tbody id="sale-tbody"></tbody></table>
    </div>
  `;
  const linesEl = document.getElementById('sale-lines');
  function addLine(it){
    const line = document.createElement('div'); line.style.marginTop='8px'; line.className='row';
    line.innerHTML = `<div style="flex:2"><select class="sel-prod">${products.map(p=>`<option value="${p.id}">${p.name}</option>`).join('')}</select></div>
      <div style="flex:1"><input class="qty" type="number" value="${it?.qty||1}" /></div>
      <div style="flex:1"><input class="rate" type="number" value="${it?.rate|| (products[0]?products[0].price:0)}" /></div>
      <div style="flex:1 right"><div class="small amt">0</div></div>
      <div style="display:flex;align-items:center"><button class="btn ghost remove-line">Remove</button></div>`;
    linesEl.appendChild(line);
    const sel = line.querySelector('.sel-prod'), qty=line.querySelector('.qty'), rate=line.querySelector('.rate'), amt=line.querySelector('.amt');
    function recalc(){ const a = Number(qty.value||0)*Number(rate.value||0); amt.innerText = '₹ '+fmt(a); renderSaleTotal(); }
    sel.onchange = ()=> { const p = products.find(x=>x.id===sel.value); if(p) rate.value = p.price; recalc(); }
    qty.oninput = rate.oninput = recalc;
    line.querySelector('.remove-line').onclick = ()=>{ line.remove(); renderSaleTotal(); }
    recalc();
  }
  document.getElementById('sale-add-line').onclick = ()=> addLine();
  function renderSaleTotal(){ const disc = Number(document.getElementById('sale-disc').value||0); let tot=0; linesEl.querySelectorAll('.row').forEach(r=>{ const q=Number(r.querySelector('.qty').value||0); const rt=Number(r.querySelector('.rate').value||0); tot += q*rt; }); tot = tot - disc; document.getElementById('sale-total').innerText = '₹ '+fmt(tot); return tot; }
  document.getElementById('sale-disc').oninput = renderSaleTotal;

  document.getElementById('save-sale').onclick = ()=>{
    const customerId = document.getElementById('sale-cust').value;
    if(!customerId){ alert('Select customer'); return; }
    const date = document.getElementById('sale-date').value;
    const invoice = document.getElementById('sale-inv').value;
    const notes = document.getElementById('sale-notes').value;
    const disc = Number(document.getElementById('sale-disc').value||0);
    const items = [];
    linesEl.querySelectorAll('.row').forEach(r=>{
      const pid = r.querySelector('.sel-prod').value;
      const qty = Number(r.querySelector('.qty').value||0);
      const rate = Number(r.querySelector('.rate').value||0);
      if(qty>0) items.push({productId:pid, qty, rate});
    });
    if(items.length===0){ alert('Add at least one line'); return; }
    let total = items.reduce((s,i)=> s + i.qty*i.rate,0) - disc;
    // GST 18%
    const tax = total * 0.18;
    const grand = total + tax;
    const sale = { id: uid('s'), invoice, customerId, date, items, subtotal: total, tax, total: grand, paid:0, due: grand, notes };
    // reduce stock
    items.forEach(it=>{ const arr = load('products'); const p = arr.find(x=>x.id===it.productId); if(p){ p.stock = Number(p.stock||0) - Number(it.qty||0); save('products',arr); } });
    const arr = load('sales'); arr.push(sale); save('sales',arr);
    alert('Invoice saved'); render('sales');
  };

  // load list
  const tb = document.getElementById('sale-tbody');
  function refreshList(){
    const arr = load('sales');
    tb.innerHTML = arr.map(s=>{
      const cust = load('customers').find(c=>c.id===s.customerId) || {};
      const status = (Number(s.paid||0) >= Number(s.total||0)) ? 'Paid' : 'Due';
      return `<tr><td>${s.invoice}</td><td>${cust.name||''}</td><td>${s.date}</td><td class="right">₹ ${fmt(s.total)}</td><td class="right">₹ ${fmt(s.paid)}</td><td>${status}</td><td class="right"><button data-id="${s.id}" class="view btn ghost">View</button> <button data-id="${s.id}" class="pay btn ghost">Pay</button></td></tr>`;
    }).join('');
    tb.querySelectorAll('.view').forEach(b=>b.onclick=()=> viewInvoice(b.dataset.id));
    tb.querySelectorAll('.pay').forEach(b=>b.onclick=()=> recordPayment('sale', b.dataset.id));
  }
  refreshList();
}

/* ---------- PURCHASES (Bills) ---------- */
function renderPurchases({products,suppliers,purchases}){
  main.innerHTML = `
    <h2>Purchases / Bills</h2>
    <div class="card">
      <div class="row">
        <div style="flex:2"><label>Supplier</label><select id="pur-sup">${suppliers.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}</select></div>
        <div style="flex:1"><label>Date</label><input id="pur-date" type="date" value="${today()}" /></div>
        <div style="flex:1"><label>Bill #</label><input id="pur-bill" value="BILL-${Date.now().toString().slice(-6)}" /></div>
      </div>
      <div style="margin-top:8px"><div id="pur-lines"></div><button id="pur-add-line" class="btn ghost" style="margin-top:8px">Add Line</button></div>
      <div class="row" style="margin-top:8px;align-items:center">
        <div style="flex:3"><label>Notes</label><input id="pur-notes" /></div>
        <div style="flex:1" class="right"><label>Total</label><div id="pur-total" class="badge">0</div></div>
      </div>
      <div style="margin-top:8px"><button id="save-pur" class="btn primary">Save Purchase</button></div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Purchases</h3>
      <table><thead><tr><th>#</th><th>Supplier</th><th>Date</th><th class="right">Total</th><th class="right">Paid</th><th></th></tr></thead><tbody id="pur-tbody"></tbody></table>
    </div>
  `;
  const linesEl = document.getElementById('pur-lines');
  function addLine(it){
    const line = document.createElement('div'); line.style.marginTop='8px'; line.className='row';
    line.innerHTML = `<div style="flex:2"><select class="sel-prod">${products.map(p=>`<option value="${p.id}">${p.name}</option>`).join('')}</select></div>
      <div style="flex:1"><input class="qty" type="number" value="${it?.qty||1}" /></div>
      <div style="flex:1"><input class="rate" type="number" value="${it?.rate|| (products[0]?products[0].cost:0)}" /></div>
      <div style="flex:1 right"><div class="small amt">0</div></div>
      <div style="display:flex;align-items:center"><button class="btn ghost remove-line">Remove</button></div>`;
    linesEl.appendChild(line);
    const sel = line.querySelector('.sel-prod'), qty=line.querySelector('.qty'), rate=line.querySelector('.rate'), amt=line.querySelector('.amt');
    function recalc(){ const a = Number(qty.value||0)*Number(rate.value||0); amt.innerText = '₹ '+fmt(a); renderPurTotal(); }
    sel.onchange = ()=> { const p = products.find(x=>x.id===sel.value); if(p) rate.value = p.cost; recalc(); }
    qty.oninput = rate.oninput = recalc;
    line.querySelector('.remove-line').onclick = ()=>{ line.remove(); renderPurTotal(); }
    recalc();
  }
  document.getElementById('pur-add-line').onclick = ()=> addLine();
  function renderPurTotal(){ let tot=0; linesEl.querySelectorAll('.row').forEach(r=>{ const q=Number(r.querySelector('.qty').value||0); const rt=Number(r.querySelector('.rate').value||0); tot += q*rt; }); document.getElementById('pur-total').innerText = '₹ '+fmt(tot); return tot; }

  document.getElementById('save-pur').onclick = ()=>{
    const supplierId = document.getElementById('pur-sup').value;
    if(!supplierId){ alert('Select supplier'); return; }
    const date = document.getElementById('pur-date').value;
    const bill = document.getElementById('pur-bill').value;
    const notes = document.getElementById('pur-notes').value;
    const items = [];
    linesEl.querySelectorAll('.row').forEach(r=>{
      const pid = r.querySelector('.sel-prod').value;
      const qty = Number(r.querySelector('.qty').value||0);
      const rate = Number(r.querySelector('.rate').value||0);
      if(qty>0) items.push({productId:pid, qty, rate});
    });
    if(items.length===0){ alert('Add at least one line'); return; }
    let total = items.reduce((s,i)=> s + i.qty*i.rate,0);
    const tax = total * 0.18; const grand = total + tax;
    const pur = { id: uid('purch'), bill, supplierId, date, items, subtotal: total, tax, total: grand, paid:0, due: grand, notes };
    // increase stock
    items.forEach(it=>{ const arr = load('products'); const p = arr.find(x=>x.id===it.productId); if(p){ p.stock = Number(p.stock||0) + Number(it.qty||0); save('products',arr); } });
    const arr = load('purchases'); arr.push(pur); save('purchases',arr);
    alert('Purchase saved'); render('purchases');
  };

  const tb = document.getElementById('pur-tbody');
  function refreshList(){
    const arr = load('purchases');
    tb.innerHTML = arr.map(s=>{
      const sup = load('suppliers').find(c=>c.id===s.supplierId) || {};
      return `<tr><td>${s.bill}</td><td>${sup.name||''}</td><td>${s.date}</td><td class="right">₹ ${fmt(s.total)}</td><td class="right">₹ ${fmt(s.paid)}</td><td class="right"><button data-id="${s.id}" class="view btn ghost">View</button> <button data-id="${s.id}" class="pay btn ghost">Pay</button></td></tr>`;
    }).join('');
    tb.querySelectorAll('.view').forEach(b=>b.onclick=()=> viewPurchase(b.dataset.id));
    tb.querySelectorAll('.pay').forEach(b=>b.onclick=()=> recordPayment('purchase', b.dataset.id));
  }
  refreshList();
}

<!-- Payments & Receipts Section -->
<section id="payments">
  <h2>Payments & Receipts</h2>
  <form id="paymentForm">
    <label for="paymentCustomer">Customer:</label>
    <select id="paymentCustomer" required></select>

    <label for="paymentType">Type:</label>
    <select id="paymentType" required>
      <option value="Payment">Payment</option>
      <option value="Receipt">Receipt</option>
    </select>

    <label for="paymentAmount">Amount:</label>
    <input type="number" id="paymentAmount" required step="0.01" />

    <button type="submit">Add Entry</button>
  </form>

  <h3>Payment & Receipt Records</h3>
  <table border="1" id="paymentsTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Customer</th>
        <th>Payment</th>
        <th>Receipt</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<script>
  // Load data from localStorage
  let customers = JSON.parse(localStorage.getItem("customers")) || [];
  let payments = JSON.parse(localStorage.getItem("payments")) || [];

  // Fill customer dropdown
  function loadCustomers() {
    const select = document.getElementById("paymentCustomer");
    select.innerHTML = "";
    customers.forEach(cust => {
      const option = document.createElement("option");
      option.value = cust.name;
      option.textContent = cust.name;
      select.appendChild(option);
    });
  }

  // Render payments table with separate Payment and Receipt columns
  function renderPayments() {
    const tbody = document.querySelector("#paymentsTable tbody");
    tbody.innerHTML = "";

    payments.forEach(p => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${p.date}</td>
        <td>${p.customer}</td>
        <td>${p.type === "Payment" ? p.amount.toFixed(2) : ""}</td>
        <td>${p.type === "Receipt" ? p.amount.toFixed(2) : ""}</td>
      `;
      tbody.appendChild(row);
    });
  }

  // Handle form submit
  document.getElementById("paymentForm").addEventListener("submit", e => {
    e.preventDefault();
    const customer = document.getElementById("paymentCustomer").value;
    const type = document.getElementById("paymentType").value;
    const amount = parseFloat(document.getElementById("paymentAmount").value);

    if (isNaN(amount) || amount <= 0) {
      alert("Please enter a valid amount.");
      return;
    }

    const entry = {
      date: new Date().toLocaleDateString(),
      customer,
      type,
      amount
    };

    payments.push(entry);
    localStorage.setItem("payments", JSON.stringify(payments));
    renderPayments();
    e.target.reset();
  });

  // Initial load
  loadCustomers();
  renderPayments();
</script>

/* ---------- Reports / Export / Import ---------- */
function renderReports({products,customers,suppliers,sales,purchases,payments}){
  main.innerHTML = `
    <h2>Reports & Export</h2>
    <div class="card">
      <h3 style="margin-top:0">Stock Summary</h3>
      <table><thead><tr><th>SKU</th><th>Product</th><th class="right">Stock</th><th class="right">Value (cost)</th></tr></thead><tbody>${products.map(p=>`<tr><td>${p.sku||''}</td><td>${p.name}</td><td class="right">${p.stock} ${p.unit||''}</td><td class="right">₹ ${fmt((p.stock||0)*(p.cost||0))}</td></tr>`).join('')}</tbody></table>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Accounts Summary</h3>
      <div class="row" style="gap:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:200px">Total Sales: <strong>₹ ${fmt(sales.reduce((a,b)=>a+(Number(b.total)||0),0))}</strong></div>
        <div style="flex:1;min-width:200px">Total Purchases: <strong>₹ ${fmt(purchases.reduce((a,b)=>a+(Number(b.total)||0),0))}</strong></div>
        <div style="flex:1;min-width:200px">Receipts: <strong>₹ ${fmt(payments.filter(p=>p.type==='receipt').reduce((a,b)=>a+Number(b.amount||0),0))}</strong></div>
        <div style="flex:1;min-width:200px">Payments: <strong>₹ ${fmt(payments.filter(p=>p.type==='payment').reduce((a,b)=>a+Number(b.amount||0),0))}</strong></div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Export / Import</h3>
      <div class="row" style="align-items:center">
        <button id="export-json" class="btn primary">Export JSON backup</button>
        <button id="download-local" class="btn ghost">Save all to .json (download)</button>
        <input id="import-file" type="file" accept=".json" />
        <button id="import-btn" class="btn ghost">Import JSON</button>
        <button id="reset-app" class="btn ghost">Reset App (clear data)</button>
      </div>
    </div>
  `;
  document.getElementById('export-json').onclick = ()=> {
    const data = {};
    LS_KEYS.forEach(k=> data[k] = load(k));
    const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'backup.json'; a.click();
  };
  document.getElementById('download-local').onclick = () => { document.getElementById('export-json').click(); };
  document.getElementById('import-btn').onclick = async ()=>{
    const f = document.getElementById('import-file').files[0]; if(!f){ alert('Choose a JSON file'); return; }
    try{
      const txt = await f.text(); const json = JSON.parse(txt);
      LS_KEYS.forEach(k=> save(k, json[k] || []));
      alert('Imported — reloading view'); render('reports');
    } catch(e){ alert('Invalid file'); console.error(e); }
  };
  document.getElementById('reset-app').onclick = ()=>{
    if(!confirm('Clear all app data? This cannot be undone.')) return;
    LS_KEYS.forEach(k=> localStorage.removeItem(k)); initIfEmpty(); render('reports');
  };
}

/* ---------- Utilities: View & Print ---------- */
function viewInvoice(id){
  const s = load('sales').find(x=>x.id===id); if(!s) return;
  const cust = load('customers').find(c=>c.id===s.customerId) || {};
  const products = load('products');
  let html = `<div style="padding:18px;font-family:system-ui"><h2>Invoice: ${s.invoice}</h2><div>Date: ${s.date}</div><div>Customer: ${cust.name || ''}</div><div style="margin-top:12px"><table style="width:100%;border-collapse:collapse"><thead><tr><th style="text-align:left">Product</th><th>Qty</th><th>Rate</th><th style="text-align:right">Amount</th></tr></thead><tbody>`;
  s.items.forEach(it => { const p = products.find(x=>x.id===it.productId) || {}; html += `<tr><td>${p.name}</td><td>${it.qty}</td><td>₹ ${fmt(it.rate)}</td><td style="text-align:right">₹ ${fmt(it.qty*it.rate)}</td></tr>` });
  html += `</tbody></table></div><div style="margin-top:12px;text-align:right">Subtotal: ₹ ${fmt(s.subtotal)}<br/>Tax: ₹ ${fmt(s.tax)}<br/><strong>Total: ₹ ${fmt(s.total)}</strong></div><div style="margin-top:12px"><button onclick="window.print()" class="btn primary">Print</button></div></div>`;
  const w = window.open('','_blank','width=900,height=700'); w.document.write(html); w.document.close();
}

function viewPurchase(id){
  const s = load('purchases').find(x=>x.id===id); if(!s) return;
  const sup = load('suppliers').find(c=>c.id===s.supplierId) || {};
  const products = load('products');
  let html = `<div style="padding:18px;font-family:system-ui"><h2>Purchase: ${s.bill}</h2><div>Date: ${s.date}</div><div>Supplier: ${sup.name || ''}</div><div style="margin-top:12px"><table style="width:100%;border-collapse:collapse"><thead><tr><th style="text-align:left">Product</th><th>Qty</th><th>Rate</th><th style="text-align:right">Amount</th></tr></thead><tbody>`;
  s.items.forEach(it => { const p = products.find(x=>x.id===it.productId) || {}; html += `<tr><td>${p.name}</td><td>${it.qty}</td><td>₹ ${fmt(it.rate)}</td><td style="text-align:right">₹ ${fmt(it.qty*it.rate)}</td></tr>` });
  html += `</tbody></table></div><div style="margin-top:12px;text-align:right">Subtotal: ₹ ${fmt(s.subtotal)}<br/>Tax: ₹ ${fmt(s.tax)}<br/><strong>Total: ₹ ${fmt(s.total)}</strong></div><div style="margin-top:12px"><button onclick="window.print()" class="btn primary">Print</button></div></div>`;
  const w = window.open('','_blank','width=900,height=700'); w.document.write(html); w.document.close();
}

/* ---------- Quick Payment from lists ---------- */
function recordPayment(kind, id){
  const amt = Number(prompt('Enter amount to record (₹)','0')||0);
  if(!amt || amt<=0) return;
  const p = { id: uid('pay'), type: kind === 'sale' ? 'receipt' : 'payment', refType: kind, refId: id, date: today(), amount: amt, method: 'Cash' };
  const arr = load('payments'); arr.unshift(p); save('payments',arr);
  if(kind==='sale'){ const sales = load('sales'); const s = sales.find(x=>x.id===id); if(s){ s.paid = Number(s.paid||0) + amt; s.due = Number(s.total||0) - s.paid; save('sales', sales); } }
  if(kind==='purchase'){ const ps = load('purchases'); const pur = ps.find(x=>x.id===id); if(pur){ pur.paid = Number(pur.paid||0) + amt; pur.due = Number(pur.total||0) - pur.paid; save('purchases', ps); } }
  alert('Payment recorded'); render();
}

/* ---------- Initial render ---------- */
render('dashboard');
</script>
</body>
</html>
